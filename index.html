<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrust - Advanced Banking Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
  /* ===================
   LOADING CIRCLE
   =================== */
.loader-container {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, #0d1117, #000);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 1s ease-out;
}

.loader-circle {
  position: relative;
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: 6px solid transparent;
  border-top: 6px solid #00ffcc;
  border-right: 6px solid #0077ff;
  border-bottom: 6px solid #00ffaa;
  border-left: 6px solid #0077ff;
  animation: rotateCircle 1.5s linear infinite;
  box-shadow: 0 0 25px rgba(0, 255, 200, 0.5);
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: center;
  align-items: center;
}

.loader-percentage {
  position: absolute;
  font-size: 2.2rem;
  font-weight: 600;
  color: #00ffcc;
  text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffaa;
}

@keyframes rotateCircle {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.fade-out {
  opacity: 0;
  pointer-events: none;
}

/* Modern Banking Theme - Professional Design */
:root {
  --primary: #0d47a1;
  --primary-dark: #093a83;
  --secondary: #0288d1;
  --success: #2e7d32;
  --warning: #f57f17;
  --danger: #c62828;
  --light: #f5f9ff;
  --dark: #1a237e;
  --gray: #e0e0e0;
  --text: #212121;
  --text-light: #757575;
  --card-bg: #ffffff;
  --sidebar-bg: #0d47a1;
  --sidebar-text: #ffffff;
  --sidebar-hover: #1565c0;
  --border-radius: 12px;
  --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
  --transition: all 0.3s ease;
  --accent: #64b5f6;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  color: var(--text);
  min-height: 100vh;
  padding: 0;
  overflow-x: hidden;
}

/* Auth Pages */
.auth-container {
  display: flex;
  min-height: 100vh;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.auth-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 2.5rem;
  box-shadow: var(--box-shadow);
  width: 100%;
  max-width: 450px;
  text-align: center;
}

.auth-logo {
  margin-bottom: 1.5rem;
  color: var(--primary);
}

.auth-logo i {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}

.auth-logo h2 {
  font-size: 1.8rem;
  font-weight: 700;
}

.form-group {
  margin-bottom: 1.2rem;
  text-align: left;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text);
}

.form-control {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 1px solid var(--gray);
  border-radius: 8px;
  font-size: 1rem;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.2);
}

.btn {
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  font-size: 1rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--primary);
  color: var(--primary);
}

.btn-outline:hover {
  background: var(--primary);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  background: #1b5e20;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover {
  background: #b71c1c;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-warning:hover {
  background: #e65100;
}

.auth-footer {
  margin-top: 1.5rem;
  color: var(--text-light);
}

.auth-footer a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}

.auth-footer a:hover {
  text-decoration: underline;
}

/* Main App Styles */
.header {
  background: var(--primary);
  color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo i {
  font-size: 2rem;
  color: #4fc3f7;
}

.logo h1 {
  font-size: 1.8rem;
  font-weight: 600;
}

.menu-toggle {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  display: none;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(45deg, #4fc3f7, #29b6f6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}

.app-container {
  display: flex;
  min-height: calc(100vh - 70px);
}

.sidebar {
  width: 260px;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  padding: 2rem 0;
  height: calc(100vh - 70px);
  position: sticky;
  top: 70px;
  overflow-y: auto;
  transition: var(--transition);
  z-index: 99;
}

.sidebar.collapsed {
  width: 0;
  padding: 0;
}

.nav-item {
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
}

.nav-item:hover, .nav-item.active {
  background: var(--sidebar-hover);
  border-left: 4px solid #4fc3f7;
}

.nav-item i {
  width: 24px;
  text-align: center;
}

.main-content {
  flex: 1;
  padding: 2rem;
  overflow-y: auto;
  transition: var(--transition);
}

.main-content.expanded {
  margin-left: 0;
}

.page-title {
  font-size: 1.8rem;
  margin-bottom: 1.5rem;
  color: var(--primary-dark);
  display: flex;
  align-items: center;
  gap: 12px;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.dashboard-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.card-title {
  font-size: 1.1rem;
  color: var(--text-light);
  font-weight: 600;
}

.card-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.balance-card .card-icon {
  background: linear-gradient(135deg, #29b6f6, #0288d1);
  color: white;
}

.investments-card .card-icon {
  background: linear-gradient(135deg, #66bb6a, #2e7d32);
  color: white;
}

.loans-card .card-icon {
  background: linear-gradient(135deg, #ff7043, #f4511e);
  color: white;
}

.business-card .card-icon {
  background: linear-gradient(135deg, #ab47bc, #8e24aa);
  color: white;
}

.trading-card .card-icon {
  background: linear-gradient(135deg, #ffeb3b, #ffc107);
  color: var(--dark);
}

.card-value {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.balance-card .card-value {
  color: var(--primary);
}

.investments-card .card-value {
  color: var(--success);
}

.loans-card .card-value {
  color: var(--danger);
}

.business-card .card-value {
  color: var(--warning);
}

.card-footer {
  display: flex;
  justify-content: space-between;
  color: var(--text-light);
  font-size: 0.9rem;
}

.asset-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.asset-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  cursor: pointer;
}

.asset-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.asset-image {
  height: 150px;
  background: linear-gradient(45deg, #e3f2fd, #bbdefb);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  color: var(--primary);
}

.asset-details {
  padding: 1.2rem;
}

.asset-name {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.asset-price {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
  margin: 0.5rem 0;
}

.asset-type {
  color: var(--text-light);
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.asset-actions {
  display: flex;
  gap: 0.8rem;
}

.list-item {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: var(--box-shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.list-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.list-item-content {
  flex: 1;
}

.list-item-title {
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.list-item-detail {
  color: var(--text-light);
  font-size: 0.9rem;
}

.list-actions {
  display: flex;
  gap: 0.8rem;
}

.wallet-balance {
  background: linear-gradient(135deg, var(--primary), var(--dark));
  color: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  text-align: center;
}

.balance-amount {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0.5rem 0;
}

.wallet-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
}

.wallet-action {
  flex: 1;
  text-align: center;
  padding: 1.2rem;
  border-radius: var(--border-radius);
  background: var(--card-bg);
  box-shadow: var(--box-shadow);
  cursor: pointer;
  transition: var(--transition);
}

.wallet-action:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.wallet-action i {
  font-size: 2rem;
  margin-bottom: 0.8rem;
  color: var(--primary);
}

.wallet-action.deposit i {
  color: var(--success);
}

.wallet-action.withdraw i {
  color: var(--danger);
}

.wallet-action.transfer i {
  color: var(--warning);
}

.chart-container {
  height: 300px;
  margin: 1.5rem 0;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  border-radius: var(--border-radius);
  width: 90%;
  max-width: 500px;
  padding: 2rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  animation: modalOpen 0.3s forwards;
  max-height: 80vh;
  overflow-y: auto;
  scroll-behavior: smooth;
}

@keyframes modalOpen {
  to { transform: scale(1); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 600;
}

.close-modal {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-light);
}

.notification {
  position: fixed;
  top: 90px;
  right: 20px;
  padding: 1rem 1.5rem;
  border-radius: var(--border-radius);
  color: white;
  font-weight: 500;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  z-index: 1001;
  transform: translateX(120%);
  transition: transform 0.4s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: var(--success);
}

.notification.error {
  background: var(--danger);
}

.profit-indicator {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 600;
}

.profit-positive {
  background: rgba(46, 125, 50, 0.1);
  color: var(--success);
}

.profit-negative {
  background: rgba(198, 40, 40, 0.1);
  color: var(--danger);
}

.loan-status {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.loan-active {
  background: rgba(245, 127, 23, 0.15);
  color: var(--warning);
}

.business-status {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  background: rgba(46, 125, 50, 0.1);
  color: var(--success);
}

.chart-section {
  margin: 2rem 0;
}

.chart-title {
  font-size: 1.3rem;
  margin-bottom: 1rem;
  color: var(--primary-dark);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.stat-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1.2rem;
  box-shadow: var(--box-shadow);
  text-align: center;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0.5rem 0;
  color: var(--primary);
}

.stat-label {
  color: var(--text-light);
  font-size: 0.9rem;
}

/* Transaction Detail Modal */
.transaction-detail {
  padding: 1.5rem;
  border-bottom: 1px solid var(--gray);
}

.transaction-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.transaction-amount {
  font-size: 1.8rem;
  font-weight: 700;
}

.transaction-positive {
  color: var(--success);
}

.transaction-negative {
  color: var(--danger);
}

.transaction-info {
  margin: 1rem 0;
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--gray);
}

.info-label {
  color: var(--text-light);
}

.info-value {
  font-weight: 600;
}

/* Asset Detail Modal */
.asset-detail-header {
  text-align: center;
  margin-bottom: 1.5rem;
}

.asset-detail-icon {
  font-size: 3rem;
  color: var(--primary);
  margin-bottom: 0.5rem;
}

.asset-detail-name {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.asset-detail-type {
  color: var(--text-light);
  font-size: 1.1rem;
}

.asset-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  margin: 1.5rem 0;
}

.stat-item {
  background: #e3f2fd;
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
}

.stat-label {
  color: var(--text-light);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.2rem;
  font-weight: 700;
}

.upgrade-section {
  background: #fff8e1;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin: 1.5rem 0;
}

.upgrade-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.upgrade-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--warning);
}

.current-version {
  background: var(--warning);
  color: white;
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-weight: 600;
}

.upgrade-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
}

/* PIN Modal */
.pin-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin: 1.5rem 0;
}

.pin-btn {
  padding: 1.2rem;
  font-size: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--gray);
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
}

.pin-btn:hover {
  background: #e3f2fd;
  border-color: var(--primary);
}

.pin-display {
  text-align: center;
  font-size: 2rem;
  letter-spacing: 10px;
  margin: 1rem 0;
  font-family: monospace;
}

.amount-display {
  text-align: center;
  font-size: 1.5rem;
  margin: 1rem 0;
  font-family: monospace;
  font-weight: bold;
  color: var(--primary);
  transition: var(--transition);
}

/* Investment Portfolio */
.portfolio-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.summary-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1.2rem;
  box-shadow: var(--box-shadow);
  text-align: center;
}

.summary-value {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0.5rem 0;
}

.summary-label {
  color: var(--text-light);
  font-size: 0.9rem;
}

/* Settings Styles */
.settings-grid {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.settings-sidebar {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1rem;
  box-shadow: var(--box-shadow);
  height: fit-content;
}

.settings-item {
  padding: 1rem;
  cursor: pointer;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  transition: var(--transition);
  font-weight: 500;
}

.settings-item:hover, .settings-item.active {
  background: var(--light);
  color: var(--primary);
}

.settings-content {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 2rem;
  box-shadow: var(--box-shadow);
}

.profile-info {
  display: flex;
  gap: 2rem;
  margin-bottom: 2rem;
}

.profile-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(45deg, #4fc3f7, #29b6f6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 1rem;
}

.profile-details {
  flex: 1;
}

.account-number {
  background: var(--light);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-family: monospace;
  font-weight: 600;
  color: var(--primary);
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.checkbox-group label {
  cursor: pointer;
  font-weight: normal;
}

/* Trading Styles */
.trading-price-change {
  font-weight: 600;
}

.price-change-positive {
  color: var(--success);
}

.price-change-negative {
  color: var(--danger);
}

.mood-display {
  font-size: 0.9rem;
  font-weight: 500;
  margin-top: 0.5rem;
}

.mood-boom, .mood-euphoric, .mood-bullish, .mood-optimistic {
  color: var(--success);
}

.mood-cautious, .mood-bearish, .mood-panic, .mood-crash {
  color: var(--danger);
}

.mood-stable {
  color: var(--text-light);
}

.mood-volatile {
  color: var(--warning);
}

.timeframe-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.timeframe-btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--gray);
  background: var(--card-bg);
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
}

.timeframe-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.export-btn {
  padding: 0.5rem 1rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 1rem;
}

.suggestion-card {
  background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
  border-left: 4px solid var(--success);
}

.suggestion-text {
  font-size: 1.1rem;
  font-weight: 600;
  padding: 1rem 0;
}

/* Enhanced Help Center Styles - Professional Structure */
.help-center-header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 2rem;
  border-radius: var(--border-radius);
  margin-bottom: 2rem;
  text-align: center;
  box-shadow: var(--box-shadow);
}

.help-center-header h2 {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.help-center-header p {
  font-size: 1.1rem;
  opacity: 0.9;
}

.help-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  background: var(--card-bg);
  padding: 0.5rem;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.help-tab {
  flex: 1;
  padding: 1rem;
  background: transparent;
  border: none;
  cursor: pointer;
  border-radius: 8px;
  font-weight: 600;
  transition: var(--transition);
  color: var(--text-light);
}

.help-tab.active {
  background: var(--primary);
  color: white;
}

.help-section {
  margin-bottom: 2rem;
}

.help-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 2rem;
  box-shadow: var(--box-shadow);
  margin-bottom: 1.5rem;
}

.help-card h3 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: var(--primary-dark);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.feature-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.feature-item {
  background: var(--light);
  padding: 1.5rem;
  border-radius: var(--border-radius);
  border-left: 4px solid var(--primary);
  transition: var(--transition);
}

.feature-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.feature-icon {
  font-size: 2rem;
  color: var(--primary);
  margin-bottom: 0.5rem;
}

.feature-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.feature-desc {
  color: var(--text-light);
  line-height: 1.5;
}

.accordion {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  margin-bottom: 1rem;
  overflow: hidden;
  box-shadow: var(--box-shadow);
}

.accordion-header {
  padding: 1.5rem;
  background: var(--light);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  transition: var(--transition);
}

.accordion-header:hover {
  background: var(--accent);
  color: white;
}

.accordion-header i {
  transition: var(--transition);
}

.accordion-header.open i {
  transform: rotate(180deg);
}

.accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  padding: 0 1.5rem;
}

.accordion-content.open {
  max-height: 500px;
  padding: 1.5rem;
}

.accordion-content ul {
  list-style: none;
  padding: 0;
}

.accordion-content li {
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--gray);
  color: var(--text-light);
}

.accordion-content li:last-child {
  border-bottom: none;
}

.complaint-categories {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.category-btn {
  padding: 0.5rem 1rem;
  background: var(--light);
  border: 1px solid var(--gray);
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: var(--transition);
}

.category-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.complaint-form {
  background: var(--light);
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 2rem;
}

.complaint-form textarea {
  width: 100%;
  height: 120px;
  padding: 1rem;
  border: 1px solid var(--gray);
  border-radius: 8px;
  resize: vertical;
  font-family: inherit;
  margin-bottom: 1rem;
  font-size: 1rem;
}

.complaint-form .btn {
  width: auto;
  padding: 0.8rem 2rem;
}

.complaint-post {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--box-shadow);
  border-left: 4px solid var(--primary);
  transition: var(--transition);
  opacity: 0;
  animation: fadeInUp 0.5s ease forwards;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.complaint-post:hover {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

.complaint-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.complaint-author {
  font-weight: 600;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.author-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: bold;
}

.complaint-date {
  color: var(--text-light);
  font-size: 0.8rem;
}

.complaint-category {
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  color: white;
}

.complaint-text {
  margin-bottom: 1rem;
  line-height: 1.6;
  color: var(--text);
}

.complaint-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--gray);
}

.like-btn {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  transition: var(--transition);
  padding: 0.5rem 1rem;
  border-radius: 20px;
}

.like-btn:hover, .like-btn.liked {
  color: var(--success);
  background: rgba(46, 125, 50, 0.1);
}

.like-count {
  font-weight: 600;
  color: var(--text);
}

.edit-btn {
  background: none;
  border: none;
  color: var(--warning);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  transition: var(--transition);
  padding: 0.5rem 1rem;
  border-radius: 20px;
}

.edit-btn:hover {
  background: rgba(245, 127, 23, 0.1);
}

.scrollable-feed {
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 1rem;
}

.loading-feedback {
  text-align: center;
  padding: 2rem;
  color: var(--text-light);
}

.loading-feedback i {
  font-size: 2rem;
  color: var(--gray);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.no-complaints {
  text-align: center;
  padding: 3rem;
  color: var(--text-light);
}

.no-complaints i {
  font-size: 4rem;
  color: var(--gray);
  margin-bottom: 1rem;
}

/* Category-specific colors */
.category-general {
  border-left-color: var(--primary);
}

.category-bug {
  border-left-color: var(--danger);
}

.category-feature {
  border-left-color: var(--warning);
}

.category-support {
  border-left-color: var(--secondary);
}

.bg-primary {
  background: var(--primary);
}

.bg-secondary {
  background: var(--secondary);
}

.bg-warning {
  background: var(--warning);
}

.bg-danger {
  background: var(--danger);
}

/* Responsive Design */
@media (max-width: 992px) {
  .menu-toggle {
    display: block;
  }
  
  .app-container {
    flex-direction: column;
  }
  
  .sidebar {
    position: fixed;
    left: 0;
    top: 70px;
    width: 260px;
    z-index: 100;
    transform: translateX(-100%);
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .main-content {
    margin-left: 0;
  }
  
  .dashboard-cards {
    grid-template-columns: 1fr;
  }
  
  .settings-grid {
    grid-template-columns: 1fr;
  }
  
  .asset-stats {
    grid-template-columns: 1fr;
  }
  
  .profile-info {
    flex-direction: column;
    text-align: center;
  }

  .help-tabs {
    flex-direction: column;
  }

  .feature-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 1rem;
  }
  
  .logo h1 {
    font-size: 1.4rem;
  }
  
  .main-content {
    padding: 1.5rem;
  }
  
  .wallet-actions {
    flex-direction: column;
  }
  
  .page-title {
    font-size: 1.5rem;
  }
  
  .pin-container {
    grid-template-columns: repeat(3, 1fr);
  }

  .complaint-header {
    flex-direction: column;
    align-items: flex-start;
  }
}

.text-center {
  text-align: center;
}

.mt-2 {
  margin-top: 1rem;
}

.hidden {
  display: none !important;
}

.collapsible {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.collapsible.open {
  max-height: 500px;
}

.expand-icon {
  transition: transform 0.3s ease;
}

.expand-icon.open {
  transform: rotate(180deg);
}

.receipt-container {
  max-width: 400px;
  margin: 0 auto;
}

.receipt-header {
  text-align: center;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid var(--gray);
  padding-bottom: 1rem;
}

.receipt-logo i {
  font-size: 3rem;
  color: var(--primary);
  margin-bottom: 0.5rem;
}

.receipt-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.receipt-details {
  margin-bottom: 2rem;
}

.receipt-row {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--gray);
}

.receipt-label {
  font-weight: 600;
}

.receipt-value {
  text-align: right;
}

.receipt-amount {
  text-align: center;
  font-size: 2rem;
  font-weight: 700;
  color: var(--success);
  margin: 1rem 0;
}

.receipt-footer {
  text-align: center;
  color: var(--text-light);
  font-size: 0.9rem;
  border-top: 1px solid var(--gray);
  padding-top: 1rem;
}

.transaction-positive {
  color: var(--success);
}

.transaction-negative {
  color: var(--danger);
}

.current-version {
  background: var(--warning);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

/* Advanced Wallet Styles */
.transaction-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--gray);
  background: var(--card-bg);
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
}

.filter-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.transaction-search {
  margin-bottom: 1rem;
}

.loan-limit-display {
  background: var(--light);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: 600;
  color: var(--primary);
  text-align: center;
  margin-bottom: 1rem;
}

/* Crash Trade Styles */
.crash-trade {
  background: linear-gradient(135deg, rgba(198, 40, 40, 0.1), rgba(198, 40, 40, 0.05));
  border-left: 4px solid var(--danger);
}

.crash-icon {
  color: var(--danger);
  margin-right: 0.5rem;
}

.receipt-container.crash-receipt .receipt-amount {
  color: var(--danger);
}

.receipt-container.crash-receipt .receipt-footer {
  color: var(--danger);
  font-weight: 600;
}

/* Admin Response Styles */
.admin-response {
  margin-top: 1rem;
  padding: 1rem;
  background: #f0f8ff;
  border-radius: 8px;
  border-left: 4px solid var(--secondary);
}

.admin-response-title {
  font-weight: 600;
  color: var(--secondary);
  margin-bottom: 0.5rem;
}

.pending-response {
  color: var(--text-light);
  font-style: italic;
}

  </style>
</head>
<body>
  <!-- Loader Screen -->
  <div class="loader-container" id="loader">
    <div class="loader-circle">
      <div class="loader-percentage" id="percentage">0%</div>
    </div>
  </div>

  <!-- Authentication Pages -->
  <div id="authContainer" class="auth-container hidden">
    <!-- Login Form -->
    <div id="loginForm" class="auth-card">
      <div class="auth-logo">
        <i class="fas fa-landmark"></i>
        <h2>FinTrust Banking</h2>
      </div>
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
      </div>
      <button class="btn btn-primary" onclick="login()">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
      <div class="auth-footer">
        Don't have an account? <a href="#" id="showRegisterLink">Create Account</a>
      </div>
    </div>

    <!-- Register Form -->
    <div id="registerForm" class="auth-card hidden">
      <div class="auth-logo">
        <i class="fas fa-landmark"></i>
        <h2>Create Account</h2>
      </div>
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" id="registerName" class="form-control" placeholder="Enter your full name">
      </div>
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="registerPassword" class="form-control" placeholder="Create a password">
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirm your password">
      </div>
      <button class="btn btn-primary" onclick="register()">
        <i class="fas fa-user-plus"></i> Create Account
      </button>
      <div class="auth-footer">
        Already have an account? <a href="#" id="showLoginLink">Sign In</a>
      </div>
    </div>
  </div>

  <!-- Main App (Hidden until login) -->
  <div id="appContainer" class="hidden">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <i class="fas fa-landmark"></i>
        <h1>FinTrust</h1>
      </div>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">JD</div>
        <span id="userName">John Doe</span>
      </div>
    </header>

    <!-- Main App Container -->
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <aside class="sidebar" id="sidebar">
        <div class="nav-item active" data-tab="dashboard">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </div>
        <div class="nav-item" data-tab="marketplace">
          <i class="fas fa-store"></i>
          <span>Marketplace</span>
        </div>
        <div class="nav-item" data-tab="trading">
          <i class="fas fa-chart-line"></i>
          <span>Smart Trading</span>
        </div>
        <div class="nav-item" data-tab="investments">
          <i class="fas fa-chart-line"></i>
          <span>My Investments</span>
        </div>
        <div class="nav-item" data-tab="wallet">
          <i class="fas fa-wallet"></i>
          <span>Wallet</span>
        </div>
        <div class="nav-item" data-tab="loans">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Loans</span>
        </div>
        <div class="nav-item" data-tab="business">
          <i class="fas fa-building"></i>
          <span>Business</span>
        </div>
        <div class="nav-item" data-tab="help-center">
          <i class="fas fa-question-circle"></i>
          <span>Help Center</span>
        </div>
        <div class="nav-item" data-tab="settings">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
        <div class="nav-item" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <!-- Dashboard Section -->
        <section id="dashboard" class="tab-content active">
          <h2 class="page-title"><i class="fas fa-tachometer-alt"></i> Financial Overview</h2>
          
          <div class="dashboard-cards">
            <div class="card balance-card">
              <div class="card-header">
                <div class="card-title">Available Balance</div>
                <div class="card-icon">
                  <i class="fas fa-wallet"></i>
                </div>
              </div>
              <div class="card-value" id="dashboard-balance">$1,000.00</div>
              <div class="card-footer">
                <span>Updated just now</span>
                <span class="profit-positive">+$120 this month</span>
              </div>
            </div>
            
            <div class="card investments-card">
              <div class="card-header">
                <div class="card-title">Total Investments</div>
                <div class="card-icon">
                  <i class="fas fa-chart-pie"></i>
                </div>
              </div>
              <div class="card-value" id="dashboard-investments">$0.00</div>
              <div class="card-footer">
                <span>0 active investments</span>
                <span class="profit-negative">0% growth</span>
              </div>
            </div>
            
            <div class="card loans-card">
              <div class="card-header">
                <div class="card-title">Active Loans</div>
                <div class="card-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
              </div>
              <div class="card-value" id="dashboard-loans">$0.00</div>
              <div class="card-footer">
                <span>0 loans</span>
                <span>0% interest</span>
              </div>
            </div>
            
            <div class="card business-card">
              <div class="card-header">
                <div class="card-title">Business Ventures</div>
                <div class="card-icon">
                  <i class="fas fa-briefcase"></i>
                </div>
              </div>
              <div class="card-value" id="dashboard-business">$0.00</div>
              <div class="card-footer">
                <span>0 businesses</span>
                <span>$0 monthly profit</span>
              </div>
            </div>
          </div>
          
          <div class="chart-section">
            <h3 class="chart-title">Financial Overview</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Assets</div>
                <div class="stat-value" id="total-assets">$1,000.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Net Worth</div>
                <div class="stat-value" id="net-worth">$1,000.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Monthly Income</div>
                <div class="stat-value" id="monthly-income">$0.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Debt Ratio</div>
                <div class="stat-value" id="debt-ratio">0%</div>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="financialChart"></canvas>
            </div>
          </div>
          
          <div class="card">
            <h3>Recent Transactions</h3>
            <div id="recent-transactions">
              <p class="text-center">No recent transactions</p>
            </div>
          </div>
        </section>

        <!-- Marketplace Section -->
        <section id="marketplace" class="tab-content">
          <h2 class="page-title"><i class="fas fa-store"></i> Investment Marketplace</h2>
          <p>Browse our curated selection of investment opportunities</p>
          
          <div class="asset-grid" id="assetGrid">
            <!-- Assets will be dynamically added here -->
          </div>
        </section>

        <!-- Trading Section -->
        <section id="trading" class="tab-content">
          <h2 class="page-title"><i class="fas fa-chart-line"></i> Smart Trading</h2>
          <p>Trade cryptocurrencies, fiat, and commodities in a simulated live market</p>
          
          <div class="card">
            <h3>Trading Portfolio Summary</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Current Portfolio Value</div>
                <div class="stat-value" id="tradingTotalValue">$0.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Unrealized P/L</div>
                <div class="stat-value" id="tradingPL">$0.00 <span class="profit-indicator" id="tradingPLIndicator"></span></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Active Positions</div>
                <div class="stat-value" id="totalTrades">0</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Select Asset to Trade</h3>
            <select id="assetSelect" class="form-control" onchange="changeAsset(this.value)">
              <option value="BTC">Bitcoin (BTC)</option>
              <option value="ETH">Ethereum (ETH)</option>
              <option value="XAU">Gold (XAU)</option>
              <option value="XAG">Silver (XAG)</option>
              <option value="OIL">Fuel (Oil)</option>
              <option value="DIA">Diamond</option>
              <option value="GBP">GBP (£)</option>
              <option value="EUR">EUR (€)</option>
              <option value="NGN">Naira (NGN)</option>
            </select>
            <div class="form-group">
              <label class="form-label">Trade From</label>
              <select id="tradeFromSelect" class="form-control">
                <option value="wallet">Wallet (USD)</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title" id="currentAssetName">Bitcoin (BTC)</div>
              <div class="card-value" id="currentPrice">$67,500.00</div>
            </div>
            <div class="card-footer">
              <span class="trading-price-change" id="priceChange">+0.00% <i class="fas fa-minus"></i></span>
            </div>
            <div id="currentMood" class="mood-display">Mood: Stable</div>
          </div>

          <div class="chart-section">
            <h3 class="chart-title">Live Price Chart (Advanced Candlestick with MA)</h3>
            <div class="timeframe-buttons">
              <button class="timeframe-btn active" data-tf="1m" onclick="setTimeframe('1m', this)">1m</button>
              <button class="timeframe-btn" data-tf="5m" onclick="setTimeframe('5m', this)">5m</button>
              <button class="timeframe-btn" data-tf="1h" onclick="setTimeframe('1h', this)">1h</button>
              <button class="timeframe-btn" data-tf="1d" onclick="setTimeframe('1d', this)">1d</button>
            </div>
            <div class="chart-container">
              <canvas id="tradingChart"></canvas>
            </div>
            <button class="export-btn" onclick="exportTradingChart()">
              <i class="fas fa-download"></i> Export Chart
            </button>
          </div>

          <div class="card suggestion-card">
            <h3>AI Trading Suggestion</h3>
            <div class="suggestion-text" id="tradingSuggestion">Analyzing market sentiment...</div>
          </div>

          <div class="card">
            <h3>Buy Asset</h3>
            <div class="form-group">
              <label class="form-label">Amount (USD)</label>
              <input type="number" id="buyAmount" class="form-control" placeholder="Enter USD amount" min="1" step="0.01">
            </div>
            <button class="btn btn-success" onclick="executeBuy()">
              <i class="fas fa-shopping-cart"></i> Buy
            </button>
          </div>

          <div class="card" id="sellSection">
            <h3>Sell Asset</h3>
            <div class="form-group">
              <label class="form-label" id="sellLabel">Units to Sell</label>
              <input type="number" id="sellUnits" class="form-control" placeholder="Enter units" min="0" step="0.0001">
            </div>
            <button class="btn btn-danger" onclick="executeSell()">
              <i class="fas fa-dollar-sign"></i> Sell Immediately
            </button>
          </div>

          <div class="card">
            <h3>Active Positions (Unsold)</h3>
            <div id="tradingPortfolioList">
              <p class="text-center">No positions yet. Start trading!</p>
            </div>
          </div>

          <div class="card">
            <h3>Trade History</h3>
            <div id="tradingHistoryList">
              <p class="text-center">No trades yet.</p>
            </div>
          </div>
        </section>

        <!-- Investments Section -->
        <section id="investments" class="tab-content">
          <h2 class="page-title"><i class="fas fa-chart-line"></i> My Investment Portfolio</h2>
          <p>Track and manage your investment assets</p>
          
          <div class="portfolio-summary">
            <div class="summary-card">
              <div class="summary-label">Total Invested</div>
              <div class="summary-value" id="total-invested">$0.00</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Current Value</div>
              <div class="summary-value" id="current-value">$0.00</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Total Profit</div>
              <div class="summary-value" id="total-profit">$0.00</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">ROI</div>
              <div class="summary-value" id="roi">0%</div>
            </div>
          </div>
          
          <div class="chart-section">
            <h3 class="chart-title">Portfolio Performance</h3>
            <div class="chart-container">
              <canvas id="portfolioChart"></canvas>
            </div>
          </div>
          
          <div id="investmentList">
            <div class="text-center">You haven't made any investments yet.</div>
          </div>
        </section>

        <!-- Wallet Section -->
        <section id="wallet" class="tab-content">
          <h2 class="page-title"><i class="fas fa-wallet"></i> Wallet Management</h2>
          
          <div class="wallet-balance">
            <div>Available Balance</div>
            <div class="balance-amount" id="walletBalance">$1,000.00</div>
            <div>Account: <span id="accountNumberDisplay">12345678</span></div>
          </div>
          
          <div class="wallet-actions">
            <div class="wallet-action transfer" onclick="openTransferModal()">
              <i class="fas fa-exchange-alt"></i>
              <div>Transfer Money</div>
            </div>
          </div>
          
          <div class="chart-section">
            <h3 class="chart-title">Transaction History</h3>
            <div class="chart-container">
              <canvas id="transactionChart"></canvas>
            </div>
          </div>
          
          <div class="card">
            <h3>Recent Transactions</h3>
            <div class="transaction-search">
              <div class="form-group">
                <label class="form-label">Search Transactions</label>
                <input type="text" id="transactionSearch" class="form-control" placeholder="Search by description..." oninput="filterTransactions()">
              </div>
            </div>
            <div class="transaction-filters">
              <button class="filter-btn active" data-filter="all" onclick="setTransactionFilter('all', this)">All</button>
              <button class="filter-btn" data-filter="transfer" onclick="setTransactionFilter('transfer', this)">Transfers</button>
              <button class="filter-btn" data-filter="investment" onclick="setTransactionFilter('investment', this)">Investments</button>
              <button class="filter-btn" data-filter="trade" onclick="setTransactionFilter('trade', this)">Trades</button>
              <button class="filter-btn" data-filter="loan" onclick="setTransactionFilter('loan', this)">Loans</button>
              <button class="filter-btn" data-filter="business" onclick="setTransactionFilter('business', this)">Business</button>
              <button class="filter-btn" data-filter="upgrade" onclick="setTransactionFilter('upgrade', this)">Upgrades</button>
              <button class="filter-btn" data-filter="repayment" onclick="setTransactionFilter('repayment', this)">Repayments</button>
            </div>
            <div id="transactionHistory">
              <p class="text-center">No transactions yet</p>
            </div>
            <button class="export-btn" onclick="exportTransactions()" style="margin-top: 1rem;">
              <i class="fas fa-download"></i> Export Transactions
            </button>
          </div>
        </section>

        <!-- Loans Section -->
        <section id="loans" class="tab-content">
          <h2 class="page-title"><i class="fas fa-file-invoice-dollar"></i> Loan Management</h2>
          
          <div class="card">
            <h3>Apply for a Loan</h3>
            <div class="loan-limit-display" id="loanLimitDisplay">Max Loan: $10,000</div>
            <div class="form-group">
              <label class="form-label">Loan Amount</label>
              <input type="number" id="loanAmount" class="form-control" placeholder="Enter amount" min="100" value="1000" max="10000">
            </div>
            <div class="form-group">
              <label class="form-label">Loan Term</label>
              <select id="loanTerm" class="form-control">
                <option value="3">3 Months (30% Interest)</option>
                <option value="6">6 Months (30% Interest)</option>
                <option value="12">12 Months (30% Interest)</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="takeLoan()">
              <i class="fas fa-paper-plane"></i> Apply for Loan
            </button>
          </div>
          
          <div class="card">
            <h3>Active Loans</h3>
            <div id="loanList">
              <p class="text-center">You don't have any active loans.</p>
            </div>
          </div>
          
          <div class="chart-section">
            <h3 class="chart-title">Loan Repayment Schedule</h3>
            <div class="chart-container">
              <canvas id="loanChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Business Section -->
        <section id="business" class="tab-content">
          <h2 class="page-title"><i class="fas fa-building"></i> Business Ventures</h2>
          
          <div class="card">
            <h3>Start a New Business</h3>
            <div class="asset-grid" id="businessOptions">
              <!-- Business options will be added here -->
            </div>
          </div>
          
          <div class="card">
            <h3>Your Businesses</h3>
            <div id="businessList">
              <p class="text-center">You haven't started any businesses yet.</p>
            </div>
          </div>
          
          <div class="chart-section">
            <h3 class="chart-title">Business Profit Forecast</h3>
            <div class="chart-container">
              <canvas id="businessChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Enhanced Help Center Section -->
        <section id="help-center" class="tab-content">
          <div class="help-center-header">
            <h2><i class="fas fa-life-ring"></i> Help Center</h2>
            <p>Your comprehensive guide to FinTrust features and support</p>
          </div>

          <div class="help-tabs">
            <button class="help-tab active" onclick="switchHelpTab('overview', this)">App Features</button>
            <button class="help-tab" onclick="switchHelpTab('guides', this)">Earning Guide</button>
            <button class="help-tab" onclick="switchHelpTab('feedback', this)">Feedback & Complaints</button>
          </div>

          <!-- App Features Overview - Advanced Styling -->
          <div id="overviewSection" class="help-section active">
            <div class="help-card">
              <h3><i class="fas fa-rocket"></i> App Features Overview</h3>
              <div class="feature-grid">
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-tachometer-alt"></i></div>
                  <div class="feature-title">Dashboard</div>
                  <div class="feature-desc">View your financial overview, balance, investments, loans, and businesses at a glance. Charts update in real-time with interactive elements for deeper insights.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-store"></i></div>
                  <div class="feature-title">Marketplace</div>
                  <div class="feature-desc">Browse and purchase 25+ investment assets like real estate, commodities, and collectibles. Each asset appreciates over time based on dynamic profit rates with upgrade options.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                  <div class="feature-title">Smart Trading</div>
                  <div class="feature-desc">Trade 9 cryptocurrencies, fiat, and commodities with live simulated market data, AI mood analysis (10 moods including Boom, Crash, Volatile), candlestick charts, and exportable analytics.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-chart-pie"></i></div>
                  <div class="feature-title">My Investments</div>
                  <div class="feature-desc">Track purchased assets, view current values, profits, ROI, and upgrade or sell them for gains. Portfolio performance visualized in doughnut charts.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-wallet"></i></div>
                  <div class="feature-title">Wallet</div>
                  <div class="feature-desc">Manage your balance, transfer funds securely with PIN authentication, and view/export filtered transaction history with advanced search.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                  <div class="feature-title">Loans</div>
                  <div class="feature-desc">Apply for loans up to your limit (increases with repayments), repay to boost limits (1.5x repaid), with fixed 30% interest over 3-12 month terms.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-building"></i></div>
                  <div class="feature-title">Business</div>
                  <div class="feature-desc">Start 22+ ventures that generate unlimited monthly profits you can collect anytime. Forecast profits with line charts for strategic planning.</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon"><i class="fas fa-cog"></i></div>
                  <div class="feature-title">Settings</div>
                  <div class="feature-desc">Update profile, security (password/PIN), notifications, and preferences (currency/language) with real-time validation and feedback.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Earning Guide - Accordion Style -->
          <div id="guidesSection" class="help-section hidden">
            <div class="help-card">
              <h3><i class="fas fa-lightbulb"></i> How to Earn Money in FinTrust</h3>
              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span>Investments & Assets</span>
                  <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="accordion-content">
                  <ul>
                    <li>Buy assets from Marketplace; they appreciate automatically (e.g., Gold at 2% per minute up to max time).</li>
                    <li>Sell for profit or upgrade for faster growth (+$500 resets timer).</li>
                    <li>Track ROI in real-time with portfolio charts.</li>
                  </ul>
                </div>
              </div>
              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span>Smart Trading</span>
                  <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="accordion-content">
                  <ul>
                    <li>Buy low/sell high using wallet funds or asset conversions, now with 10 AI moods (Boom for gains, Crash for losses, Volatile for swings).</li>
                    <li>Unrealized P/L updates live; export charts for analysis.</li>
                    <li>AI mood analysis guides decisions across balanced, frustrating, and extreme market scenarios.</li>
                  </ul>
                </div>
              </div>
              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span>Business Ventures</span>
                  <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="accordion-content">
                  <ul>
                    <li>Start businesses with initial cost; collect monthly profits repeatedly (no limit).</li>
                    <li>Forecast with charts; diversify across 22+ options.</li>
                  </ul>
                </div>
              </div>
              <div class="accordion" onclick="toggleAccordion(this)">
                <div class="accordion-header">
                  <span>Loans & Advanced Strategies</span>
                  <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="accordion-content">
                  <ul>
                    <li>Take loans to fund investments/businesses; repay to increase limits (1.5x repaid amount).</li>
                    <li>New users get $1000 welcome bonus; compound earnings in USD.</li>
                    <li>Monitor net worth, debt ratio on Dashboard.</li>
                  </ul>
                </div>
              </div>
              <div class="text-center mt-2">
                <em><strong>Pro Tip:</strong> Diversify across assets, trade on positive AI moods like Boom/Bullish, avoid Crash/Panic, and collect business profits regularly for steady growth.</em>
              </div>
            </div>
          </div>

          <!-- Enhanced Feedback Posting Display -->
          <div id="feedbackSection" class="help-section hidden">
            <div class="help-card">
              <h3><i class="fas fa-comment-dots"></i> Share Feedback & Complaints</h3>
              <div class="complaint-form">
                <div class="complaint-categories">
                  <button class="category-btn active" data-category="general" onclick="selectCategory(this)">General</button>
                  <button class="category-btn" data-category="bug" onclick="selectCategory(this)">Bug Report</button>
                  <button class="category-btn" data-category="feature" onclick="selectCategory(this)">Feature Request</button>
                  <button class="category-btn" data-category="support" onclick="selectCategory(this)">Support</button>
                </div>
                <textarea id="complaintText" placeholder="Share your detailed complaint or feedback publicly... (max 500 chars)"></textarea>
                <div class="text-right">
                  <button class="btn btn-primary" onclick="postComplaint()">Post Feedback</button>
                </div>
              </div>
            </div>

            <div class="loading-feedback" id="feedbackLoading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Loading feedback...</p>
            </div>

            <div id="complaintsList" class="scrollable-feed">
              <div class="no-complaints">
                <i class="fas fa-comments"></i>
                <p>No feedback yet. Be the first to share your thoughts!</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="tab-content">
          <h2 class="page-title"><i class="fas fa-cog"></i> Account Settings</h2>
          
          <div class="settings-grid">
            <div class="settings-sidebar">
              <div class="settings-item active" data-setting="profile">Profile Information</div>
              <div class="settings-item" data-setting="security">Security</div>
              <div class="settings-item" data-setting="notifications">Notifications</div>
              <div class="settings-item" data-setting="preferences">Preferences</div>
            </div>
            
            <div class="settings-content">
              <div id="profileSettings" class="active">
                <h3>Profile Information</h3>
                <div class="profile-info">
                  <div class="profile-avatar" id="profileAvatar">JD</div>
                  <div class="profile-details">
                    <div class="form-group">
                      <label class="form-label">Full Name</label>
                      <input type="text" id="profileName" class="form-control" value="John Doe">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Email Address</label>
                      <input type="email" id="profileEmail" class="form-control" value="john.doe@example.com">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Account Number</label>
                      <div class="account-number" id="profileAccountNumber">12345678</div>
                    </div>
                  </div>
                </div>
                <button class="btn btn-primary" onclick="updateProfile()">
                  <i class="fas fa-save"></i> Save Changes
                </button>
              </div>
              
              <div id="securitySettings" class="hidden">
                <h3>Security Settings</h3>
                <div class="form-group">
                  <label class="form-label">Current Password</label>
                  <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                </div>
                <div class="form-group">
                  <label class="form-label">New Password</label>
                  <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                </div>
                <div class="form-group">
                  <label class="form-label">Confirm New Password</label>
                  <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
                </div>
                <div class="form-group">
                  <label class="form-label">Wallet PIN</label>
                  <button class="btn btn-warning" onclick="openPinModal()">
                    <i class="fas fa-key"></i> Set/Change PIN
                  </button>
                </div>
                <button class="btn btn-primary" onclick="updatePassword()">
                  <i class="fas fa-lock"></i> Update Password
                </button>
              </div>
              
              <div id="notificationsSettings" class="hidden">
                <h3>Notification Preferences</h3>
                <div class="checkbox-group">
                  <input type="checkbox" id="emailNotifications" checked>
                  <label for="emailNotifications">Email Notifications</label>
                </div>
                <div class="checkbox-group">
                  <input type="checkbox" id="smsNotifications">
                  <label for="smsNotifications">SMS Notifications</label>
                </div>
                <div class="checkbox-group">
                  <input type="checkbox" id="transactionAlerts" checked>
                  <label for="transactionAlerts">Transaction Alerts</label>
                </div>
                <button class="btn btn-primary" onclick="saveNotifications()">
                  <i class="fas fa-bell"></i> Save Preferences
                </button>
              </div>
              
              <div id="preferencesSettings" class="hidden">
                <h3>Display Preferences</h3>
                <div class="form-group">
                  <label class="form-label">Currency</label>
                  <select id="currencySelect" class="form-control">
                    <option value="USD">USD - US Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Language</label>
                  <select id="languageSelect" class="form-control">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="savePreferences()">
                  <i class="fas fa-palette"></i> Save Preferences
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal" id="transferModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Transfer Money</h3>
        <button class="close-modal" onclick="closeModal('transferModal')">&times;</button>
      </div>
      <div class="transfer-form">
        <div class="form-group">
          <label class="form-label">Recipient Account Number</label>
          <input type="text" id="recipientAccount" class="form-control" placeholder="Enter 8-digit account number" maxlength="8">
        </div>
        <div class="recipient-info hidden" id="recipientInfo">
          <div class="recipient-name" id="recipientName">John Doe</div>
          <div>Account: <span id="recipientAccountDisplay">12345678</span></div>
        </div>
        <div class="form-group">
          <label class="form-label">Amount to Transfer</label>
          <div class="amount-display" id="transferAmountDisplay">$0.00</div>
          <div class="pin-container">
            <button class="pin-btn" onclick="addTransferAmount('1')">1</button>
            <button class="pin-btn" onclick="addTransferAmount('2')">2</button>
            <button class="pin-btn" onclick="addTransferAmount('3')">3</button>
            <button class="pin-btn" onclick="addTransferAmount('4')">4</button>
            <button class="pin-btn" onclick="addTransferAmount('5')">5</button>
            <button class="pin-btn" onclick="addTransferAmount('6')">6</button>
            <button class="pin-btn" onclick="addTransferAmount('7')">7</button>
            <button class="pin-btn" onclick="addTransferAmount('8')">8</button>
            <button class="pin-btn" onclick="addTransferAmount('9')">9</button>
            <button class="pin-btn" onclick="clearTransferAmount()"><i class="fas fa-backspace"></i></button>
            <button class="pin-btn" onclick="addTransferAmount('0')">0</button>
            <button class="pin-btn" onclick="addTransferAmount('.')">.</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Description (Optional)</label>
          <input type="text" id="transferDescription" class="form-control" placeholder="Reason for transfer">
        </div>
        <button class="btn btn-warning" onclick="validateTransfer()">
          <i class="fas fa-paper-plane"></i> Continue
        </button>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Set Wallet PIN</h3>
        <button class="close-modal" onclick="closeModal('pinModal')">&times;</button>
      </div>
      <p>Enter a 4-digit PIN for your wallet transactions</p>
      <div class="pin-display" id="pinDisplay">----</div>
      <div class="pin-container">
        <button class="pin-btn" onclick="addPinDigit('1')">1</button>
        <button class="pin-btn" onclick="addPinDigit('2')">2</button>
        <button class="pin-btn" onclick="addPinDigit('3')">3</button>
        <button class="pin-btn" onclick="addPinDigit('4')">4</button>
        <button class="pin-btn" onclick="addPinDigit('5')">5</button>
        <button class="pin-btn" onclick="addPinDigit('6')">6</button>
        <button class="pin-btn" onclick="addPinDigit('7')">7</button>
        <button class="pin-btn" onclick="addPinDigit('8')">8</button>
        <button class="pin-btn" onclick="addPinDigit('9')">9</button>
        <button class="pin-btn" onclick="clearPin()"><i class="fas fa-backspace"></i></button>
        <button class="pin-btn" onclick="addPinDigit('0')">0</button>
        <button class="pin-btn" onclick="confirmPin()"><i class="fas fa-check"></i></button>
      </div>
    </div>
  </div>

  <!-- Password Confirmation Modal with Keypad -->
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Confirm Transfer</h3>
        <button class="close-modal" onclick="closeModal('passwordModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">Enter Your Wallet PIN</label>
        <div class="pin-display" id="transferPinDisplay">----</div>
        <div class="pin-container">
          <button class="pin-btn" onclick="addTransferPin('1')">1</button>
          <button class="pin-btn" onclick="addTransferPin('2')">2</button>
          <button class="pin-btn" onclick="addTransferPin('3')">3</button>
          <button class="pin-btn" onclick="addTransferPin('4')">4</button>
          <button class="pin-btn" onclick="addTransferPin('5')">5</button>
          <button class="pin-btn" onclick="addTransferPin('6')">6</button>
          <button class="pin-btn" onclick="addTransferPin('7')">7</button>
          <button class="pin-btn" onclick="addTransferPin('8')">8</button>
          <button class="pin-btn" onclick="addTransferPin('9')">9</button>
          <button class="pin-btn" onclick="clearTransferPin()"><i class="fas fa-backspace"></i></button>
          <button class="pin-btn" onclick="addTransferPin('0')">0</button>
          <button class="pin-btn" onclick="confirmTransferPin()"><i class="fas fa-check"></i></button>
        </div>
      </div>
      <div class="recipient-info">
        <div class="recipient-name" id="confirmRecipientName">John Doe</div>
        <div>Account: <span id="confirmRecipientAccount">12345678</span></div>
        <div>Amount: $<span id="confirmTransferAmount">0.00</span></div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal">
    <div class="modal-content">
      <div class="receipt-container" id="receiptContent">
        <div class="receipt-header">
          <div class="receipt-logo">
            <i class="fas fa-landmark"></i>
          </div>
          <div class="receipt-title">FinTrust Banking</div>
          <div>Secure Money Transfer Receipt</div>
        </div>
        <div class="receipt-details">
          <div class="receipt-row">
            <div class="receipt-label">Transaction ID:</div>
            <div class="receipt-value" id="receiptId">FT-123456789</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Date & Time:</div>
            <div class="receipt-value" id="receiptDateTime">June 15, 2023 10:30 AM</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">From Account:</div>
            <div class="receipt-value" id="receiptFromAccount">12345678</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">To Account:</div>
            <div class="receipt-value" id="receiptToAccount">87654321</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Recipient Name:</div>
            <div class="receipt-value" id="receiptRecipientName">Jane Smith</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Description:</div>
            <div class="receipt-value" id="receiptDescription">Payment for services</div>
          </div>
        </div>
        <div class="receipt-amount" id="receiptAmount">$500.00</div>
        <div class="receipt-footer">
          This is an electronic receipt. No signature required.<br>
          Thank you for using FinTrust Banking!
        </div>
      </div>
      <div class="text-center mt-2">
        <button class="btn btn-primary" onclick="downloadReceipt()">
          <i class="fas fa-download"></i> Download Receipt
        </button>
        <button class="btn btn-outline" onclick="closeModal('receiptModal')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Trade Receipt Modal -->
  <div class="modal" id="tradeReceiptModal">
    <div class="modal-content">
      <div class="receipt-container" id="tradeReceiptContent">
        <div class="receipt-header">
          <div class="receipt-logo">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="receipt-title">FinTrust Trading</div>
          <div>Trade Event Receipt</div>
        </div>
        <div class="receipt-details">
          <div class="receipt-row">
            <div class="receipt-label">Trade ID:</div>
            <div class="receipt-value" id="tradeReceiptId">TT-123456789</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Date & Time:</div>
            <div class="receipt-value" id="tradeReceiptDateTime">October 13, 2025 14:30 PM</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Account:</div>
            <div class="receipt-value" id="tradeReceiptAccount">12345678</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Asset:</div>
            <div class="receipt-value" id="tradeReceiptAsset">Bitcoin (BTC)</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Event Type:</div>
            <div class="receipt-value" id="tradeReceiptType">Market Crash Wipeout</div>
          </div>
          <div class="receipt-row">
            <div class="receipt-label">Description:</div>
            <div class="receipt-value" id="tradeReceiptDescription">Positions wiped to $0 due to crash</div>
          </div>
        </div>
        <div class="receipt-amount" id="tradeReceiptAmount">-$1,250.00</div>
        <div class="receipt-footer crash-receipt-footer">
          Market Crash Event - Permanent Loss Recorded.<br>
          This is an electronic receipt. No recovery possible.
        </div>
      </div>
      <div class="text-center mt-2">
        <button class="btn btn-primary" onclick="downloadTradeReceipt()">
          <i class="fas fa-download"></i> Download Receipt
        </button>
        <button class="btn btn-outline" onclick="closeModal('tradeReceiptModal')">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Transaction Detail Modal -->
  <div class="modal" id="transactionDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Transaction Details</h3>
        <button class="close-modal" onclick="closeModal('transactionDetailModal')">&times;</button>
      </div>
      <div class="transaction-detail" id="transactionDetailContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Trade Detail Modal -->
  <div class="modal" id="tradeDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Trade Details</h3>
        <button class="close-modal" onclick="closeModal('tradeDetailModal')">&times;</button>
      </div>
      <div class="trade-detail" id="tradeDetailContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Asset Detail Modal -->
  <div class="modal" id="assetDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Asset Details</h3>
        <button class="close-modal" onclick="closeModal('assetDetailModal')">&times;</button>
      </div>
      <div class="asset-detail-content" id="assetDetailContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Edit Complaint Modal -->
  <div class="modal" id="editComplaintModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Feedback</h3>
        <button class="close-modal" onclick="closeModal('editComplaintModal')">&times;</button>
      </div>
      <div class="complaint-form">
        <div class="complaint-categories" id="editCategories">
          <button class="category-btn active" data-category="general" onclick="selectCategory(this)">General</button>
          <button class="category-btn" data-category="bug" onclick="selectCategory(this)">Bug Report</button>
          <button class="category-btn" data-category="feature" onclick="selectCategory(this)">Feature Request</button>
          <button class="category-btn" data-category="support" onclick="selectCategory(this)">Support</button>
        </div>
        <textarea id="editComplaintText" placeholder="Share your detailed complaint or feedback publicly... (max 500 chars)"></textarea>
        <div class="text-right">
          <button class="btn btn-primary" onclick="updateComplaint()">Update Feedback</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
      let percentage = 0;
const percentageText = document.getElementById("percentage");
const loader = document.getElementById("loader");

// 15 seconds / 100 = 150ms per step
const interval = setInterval(() => {
  percentage++;
  percentageText.textContent = `${percentage}%`;

  if (percentage >= 100) {
    clearInterval(interval);
    loader.classList.add("fade-out");

    // After fade-out (1s), hide loader and signal loaded
    setTimeout(() => {
      loader.style.display = "none";
      document.body.classList.add('loaded');
    }, 1000);
  }
}, 150);
  </script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getDatabase, ref, onValue, set, get, update, remove, push } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDFThcQRLf9NnJLTvCZWLBoAXMOty9m4PQ",
      authDomain: "fintrust-9f392.firebaseapp.com",
      databaseURL: "https://fintrust-9f392-default-rtdb.firebaseio.com",
      projectId: "fintrust-9f392",
      storageBucket: "fintrust-9f392.firebasestorage.app",
      messagingSenderId: "447327595631",
      appId: "1:447327595631:web:d74825f1c68bbfcf6e319a",
      measurementId: "G-E5ZRHHX3EK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // Global market prices reference for real-time sync
    const marketPricesRef = ref(db, 'market/prices');
    const marketMoodsRef = ref(db, 'market/moods');

    // Global variables
    let currentUser = null;
    let currentAccount = null;
    let users = {}; // In-memory cache of all users
    let userListener = null; // Current user listener
    let complaintsListener = null; // Complaints listener
    let configListener = null; // New: Config listener
    let moodsListener = null; // New: Moods listener
    let activitiesListener = null; // New: Activities for monitoring
    let complaints = []; // In-memory complaints
    let appConfig = {}; // New: Global config
    let currentPin = '';
    let transferAmount = '0';
    let transferPin = '';
    let currentTransactionFilter = 'all';
    let transactionSearchTerm = '';
    let currentCategory = 'general';
    let editingKey = null;
    
    // Extended Asset Data with additional 9 assets (total 25)
    const assets = [
      { 
        id: 1, 
        name: "Gold", 
        type: "Precious Metal", 
        price: 5000, 
        icon: "fas fa-gem", 
        category: "commodities",
        profitRate: 0.02, // 2% per minute
        minTime: 10, // minutes
        maxTime: 40,
        description: "Gold is a precious metal that has been used as a store of value for centuries. It tends to hold its value over time and can be a hedge against inflation."
      },
      { 
        id: 2, 
        name: "House", 
        type: "Real Estate", 
        price: 300000, 
        icon: "fas fa-home", 
        category: "real-estate",
        profitRate: 0.015, // 1.5% per minute
        minTime: 15,
        maxTime: 35,
        description: "Real estate investments provide both rental income and potential appreciation in property value over time."
      },
      { 
        id: 3, 
        name: "Car", 
        type: "Vehicle", 
        price: 50000, 
        icon: "fas fa-car", 
        category: "vehicles",
        profitRate: 0.025, // 2.5% per minute
        minTime: 10,
        maxTime: 30,
        description: "Luxury vehicles can appreciate in value, especially limited edition models and classic cars."
      },
      { 
        id: 4, 
        name: "Diamond", 
        type: "Precious Stone", 
        price: 10000, 
        icon: "fas fa-diamond", 
        category: "commodities",
        profitRate: 0.03, // 3% per minute
        minTime: 20,
        maxTime: 40,
        description: "Diamonds are rare gemstones that maintain their value and can appreciate over time, especially high-quality stones."
      },
      { 
        id: 5, 
        name: "Land", 
        type: "Real Estate", 
        price: 100000, 
        icon: "fas fa-mountain", 
        category: "real-estate",
        profitRate: 0.018, // 1.8% per minute
        minTime: 25,
        maxTime: 40,
        description: "Land is a finite resource that typically appreciates in value as populations grow and development expands."
      },
      { 
        id: 6, 
        name: "Jet", 
        type: "Vehicle", 
        price: 5000000, 
        icon: "fas fa-plane", 
        category: "vehicles",
        profitRate: 0.035, // 3.5% per minute
        minTime: 30,
        maxTime: 40,
        description: "Private jets are luxury assets that can generate income through charter services and appreciate in value for rare models."
      },
      { 
        id: 7, 
        name: "Stocks", 
        type: "Equity", 
        price: 10000, 
        icon: "fas fa-chart-line", 
        category: "stocks",
        profitRate: 0.04,
        minTime: 5,
        maxTime: 50,
        description: "Invest in blue-chip stocks for long-term growth and dividend income."
      },
      { 
        id: 8, 
        name: "Bonds", 
        type: "Fixed Income", 
        price: 5000, 
        icon: "fas fa-file-invoice", 
        category: "bonds",
        profitRate: 0.01,
        minTime: 20,
        maxTime: 60,
        description: "Government and corporate bonds provide stable returns with low risk."
      },
      { 
        id: 9, 
        name: "Art", 
        type: "Collectible", 
        price: 20000, 
        icon: "fas fa-paint-brush", 
        category: "art",
        profitRate: 0.05,
        minTime: 30,
        maxTime: 90,
        description: "Fine art pieces from renowned artists often appreciate significantly over time."
      },
      { 
        id: 10, 
        name: "Wine", 
        type: "Collectible", 
        price: 15000, 
        icon: "fas fa-wine-glass", 
        category: "wine",
        profitRate: 0.03,
        minTime: 40,
        maxTime: 120,
        description: "Vintage wines can yield high returns as they mature and become rarer."
      },
      { 
        id: 11, 
        name: "Yacht", 
        type: "Vehicle", 
        price: 1000000, 
        icon: "fas fa-ship", 
        category: "vehicles",
        profitRate: 0.04,
        minTime: 20,
        maxTime: 50,
        description: "Luxury yachts can be chartered for income while appreciating in value."
      },
      { 
        id: 12, 
        name: "Farm", 
        type: "Agriculture", 
        price: 50000, 
        icon: "fas fa-tractor", 
        category: "agriculture",
        profitRate: 0.02,
        minTime: 15,
        maxTime: 40,
        description: "Farmland provides steady income from crops and rising land values."
      },
      { 
        id: 13, 
        name: "Startup Equity", 
        type: "Equity", 
        price: 25000, 
        icon: "fas fa-rocket", 
        category: "startups",
        profitRate: 0.06,
        minTime: 10,
        maxTime: 30,
        description: "Early-stage startup shares offer high growth potential."
      },
      { 
        id: 14, 
        name: "Crypto Fund", 
        type: "Crypto", 
        price: 8000, 
        icon: "fas fa-coins", 
        category: "crypto",
        profitRate: 0.05,
        minTime: 5,
        maxTime: 20,
        description: "Diversified cryptocurrency fund for balanced exposure."
      },
      { 
        id: 15, 
        name: "Green Energy", 
        type: "Energy", 
        price: 40000, 
        icon: "fas fa-leaf", 
        category: "energy",
        profitRate: 0.035,
        minTime: 25,
        maxTime: 60,
        description: "Invest in renewable energy projects for sustainable returns."
      },
      { 
        id: 16, 
        name: "Commercial Property", 
        type: "Real Estate", 
        price: 200000, 
        icon: "fas fa-building", 
        category: "commercial",
        profitRate: 0.025,
        minTime: 30,
        maxTime: 70,
        description: "Office and retail spaces generate rental income and capital gains."
      },
      { 
        id: 17, 
        name: "Oil Rig", 
        type: "Energy", 
        price: 1000000, 
        icon: "fas fa-oil-can", 
        category: "energy",
        profitRate: 0.045,
        minTime: 35,
        maxTime: 80,
        description: "Offshore oil rigs offer high yields from energy production but carry operational risks."
      },
      { 
        id: 18, 
        name: "Luxury Watch", 
        type: "Collectible", 
        price: 25000, 
        icon: "fas fa-clock", 
        category: "collectibles",
        profitRate: 0.04,
        minTime: 25,
        maxTime: 60,
        description: "High-end timepieces from brands like Rolex appreciate as collector items."
      },
      { 
        id: 19, 
        name: "Vintage Car", 
        type: "Vehicle", 
        price: 75000, 
        icon: "fas fa-car-side", 
        category: "vehicles",
        profitRate: 0.03,
        minTime: 20,
        maxTime: 50,
        description: "Classic automobiles gain value through rarity and historical significance."
      },
      { 
        id: 20, 
        name: "Solar Farm", 
        type: "Energy", 
        price: 150000, 
        icon: "fas fa-solar-panel", 
        category: "energy",
        profitRate: 0.028,
        minTime: 30,
        maxTime: 70,
        description: "Sustainable solar energy installations provide green returns with government incentives."
      },
      { 
        id: 21, 
        name: "E-commerce Platform", 
        type: "Digital Business", 
        price: 50000, 
        icon: "fas fa-shopping-bag", 
        category: "digital",
        profitRate: 0.055,
        minTime: 15,
        maxTime: 40,
        description: "Online marketplaces scale rapidly with low overhead and global reach."
      },
      { 
        id: 22, 
        name: "Rare Coins", 
        type: "Collectible", 
        price: 12000, 
        icon: "fas fa-coins", 
        category: "collectibles",
        profitRate: 0.035,
        minTime: 20,
        maxTime: 50,
        description: "Numismatic coins from historical eras command premium prices among collectors."
      },
      { 
        id: 23, 
        name: "Biotech Stock", 
        type: "Equity", 
        price: 15000, 
        icon: "fas fa-dna", 
        category: "stocks",
        profitRate: 0.065,
        minTime: 10,
        maxTime: 30,
        description: "Biotechnology firms drive innovation in healthcare with high growth potential."
      },
      { 
        id: 24, 
        name: "Government Bonds", 
        type: "Fixed Income", 
        price: 8000, 
        icon: "fas fa-landmark", 
        category: "bonds",
        profitRate: 0.012,
        minTime: 25,
        maxTime: 70,
        description: "Low-risk securities backed by governments for steady, predictable income."
      },
      { 
        id: 25, 
        name: "Sculpture", 
        type: "Art", 
        price: 30000, 
        icon: "fas fa-palette", 
        category: "art",
        profitRate: 0.045,
        minTime: 35,
        maxTime: 90,
        description: "Contemporary sculptures by emerging artists offer cultural and financial value."
      }
    ];
    
    // Extended Business Data with additional 9 businesses (total 22) - Updated to 2% monthly profit
    const businesses = [
      { name: "Small Shop", cost: 10000, monthlyProfit: 200, icon: "fas fa-store" },
      { name: "Restaurant", cost: 50000, monthlyProfit: 1000, icon: "fas fa-utensils" },
      { name: "Tech Startup", cost: 100000, monthlyProfit: 2000, icon: "fas fa-laptop-code" },
      { name: "Online Store", cost: 20000, monthlyProfit: 400, icon: "fas fa-shopping-cart" },
      { name: "Coffee Shop", cost: 30000, monthlyProfit: 600, icon: "fas fa-coffee" },
      { name: "Gym", cost: 40000, monthlyProfit: 800, icon: "fas fa-dumbbell" },
      { name: "Salon", cost: 25000, monthlyProfit: 500, icon: "fas fa-cut" },
      { name: "Bakery", cost: 35000, monthlyProfit: 700, icon: "fas fa-bread-slice" },
      { name: "Car Wash", cost: 15000, monthlyProfit: 300, icon: "fas fa-car-wash" },
      { name: "Tutoring Center", cost: 10000, monthlyProfit: 200, icon: "fas fa-chalkboard-teacher" },
      { name: "Pet Store", cost: 20000, monthlyProfit: 400, icon: "fas fa-paw" },
      { name: "Food Truck", cost: 25000, monthlyProfit: 500, icon: "fas fa-truck" },
      { name: "Consulting Firm", cost: 50000, monthlyProfit: 1000, icon: "fas fa-handshake" },
      { name: "Bookstore", cost: 18000, monthlyProfit: 360, icon: "fas fa-book" },
      { name: "Laundry Service", cost: 12000, monthlyProfit: 240, icon: "fas fa-tshirt" },
      { name: "Photography Studio", cost: 22000, monthlyProfit: 440, icon: "fas fa-camera" },
      { name: "Event Planning", cost: 30000, monthlyProfit: 600, icon: "fas fa-calendar-alt" },
      { name: "Software Development", cost: 60000, monthlyProfit: 1200, icon: "fas fa-code" },
      { name: "Fitness Center", cost: 45000, monthlyProfit: 900, icon: "fas fa-running" },
      { name: "Daycare", cost: 28000, monthlyProfit: 560, icon: "fas fa-child" },
      { name: "Cleaning Service", cost: 15000, monthlyProfit: 300, icon: "fas fa-broom" },
      { name: "Graphic Design", cost: 20000, monthlyProfit: 400, icon: "fas fa-paint-brush" }
    ];
    
    // Trading Assets
    const tradingAssets = [
      { id: 'BTC', name: 'Bitcoin', basePrice: 67500, unit: 'BTC', fluctuation: { min: 0.005, max: 0.35 }, type: 'crypto', isFiat: false },
      { id: 'ETH', name: 'Ethereum', basePrice: 3200, unit: 'ETH', fluctuation: { min: 0.003, max: 0.25 }, type: 'crypto', isFiat: false },
      { id: 'XAU', name: 'Gold', basePrice: 78, unit: 'g', fluctuation: { min: 0.002, max: 0.15 }, type: 'commodity', isFiat: false },
      { id: 'XAG', name: 'Silver', basePrice: 0.90, unit: 'g', fluctuation: { min: 0.003, max: 0.20 }, type: 'commodity', isFiat: false },
      { id: 'OIL', name: 'Fuel (Oil)', basePrice: 1.20, unit: 'L', fluctuation: { min: 0.001, max: 0.10 }, type: 'commodity', isFiat: false },
      { id: 'DIA', name: 'Diamond', basePrice: 1800, unit: 'Carat', fluctuation: { min: 0.001, max: 0.12 }, type: 'commodity', isFiat: false },
      { id: 'GBP', name: 'GBP', basePrice: 0.80, unit: '£', fluctuation: { min: 0.0005, max: 0.02 }, type: 'fiat', isFiat: true },
      { id: 'EUR', name: 'EUR', basePrice: 0.93, unit: '€', fluctuation: { min: 0.0005, max: 0.02 }, type: 'fiat', isFiat: true },
      { id: 'NGN', name: 'Naira', basePrice: 1500, unit: '₦', fluctuation: { min: 0.0005, max: 0.05 }, type: 'fiat', isFiat: true }
    ];
    
    // Market simulation data
    let marketPrices = {};
    let marketHistory = {};
    let prevPrices = {};
    let currentTimeframe = '1m';
    let tradingChart = null;
    let selectedAsset = 'BTC';
    let moodStates = {};
    let momentums = {};
    let currentSentiments = {};
    let updateCount = 0;
    let previousMoods = {}; // Track previous moods for change detection
    
    // Chart instances
    let financialChart, portfolioChart, transactionChart, loanChart, businessChart;
    
    // New: Activity logging function
    async function logActivity(type, details = '') {
      if (!currentAccount) return;
      const activitiesRef = ref(db, 'activities');
      const newActivity = push(activitiesRef);
      await set(newActivity, {
        type: `user_${type}`,
        user: currentAccount,
        details,
        timestamp: new Date().toISOString()
      });
    }
    
    // Firebase Functions
    async function loadAllUsers() {
      const snapshot = await get(ref(db, 'users'));
      if (snapshot.exists()) {
        users = snapshot.val();
      } else {
        users = {};
      }
    }

    function attachUserListener(account) {
      if (userListener) {
        userListener();
      }
      const userRef = ref(db, `users/${account}`);
      userListener = onValue(userRef, async (snapshot) => {
        if (snapshot.exists()) {
          currentUser = { ...snapshot.val() };
          // New: Check for suspended status
          if (currentUser.status === 'suspended') {
            showNotification('User account suspended 🔒', 'error');
            logout();
            return;
          }
          // Initialize missing fields to prevent undefined errors
          currentUser.balance = currentUser.balance || 0;
          currentUser.loanLimit = currentUser.loanLimit || (appConfig.initialLoanLimit || 10000);
          currentUser.investments = currentUser.investments || [];
          currentUser.tradingPortfolio = currentUser.tradingPortfolio || [];
          currentUser.tradeHistory = currentUser.tradeHistory || [];
          if (currentUser.tradeHistory) {
            currentUser.tradeHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          }
          currentUser.transactions = currentUser.transactions || [];
          currentUser.loans = currentUser.loans || [];
          currentUser.businesses = currentUser.businesses || [];
          currentUser.walletPin = currentUser.walletPin || null;
          currentUser.notifications = currentUser.notifications || {
            email: true,
            sms: false,
            alerts: true
          };
          currentUser.preferences = currentUser.preferences || {
            currency: 'USD',
            language: 'en'
          };
          // Trigger UI updates for ALL features immediately without page refresh
          await updateDashboard();
          await updateWallet();
          await renderTransactions();
          await renderInvestments();
          await renderLoans();
          await renderBusinesses();
          await updateCharts();
          updateTradingSummary();
          renderTradingPortfolio();
          renderTradingHistory();
          updateLoanLimitDisplay();
          updateInvestmentSummary();
          // Additional real-time updates for active tabs
          const activeTab = document.querySelector('.tab-content.active').id;
          if (activeTab === 'trading') {
            updateTradingUI();
          } else if (activeTab === 'wallet') {
            filterTransactions(); // Re-apply current filter/search
          } else if (activeTab === 'loans') {
            // Re-render if needed
          }
          // Ensure marketplace and business options are static but refreshed if dynamic data added in future
          renderAssets();
          renderBusinessOptions();
        }
      }, (error) => {
        console.error('Real-time listener error:', error);
        showNotification('Connection issue detected. Retrying...', 'error');
      });
    }

    // New: Config listener
    function attachConfigListener() {
      if (configListener) configListener();
      const configRef = ref(db, 'config');
      configListener = onValue(configRef, (snapshot) => {
        if (snapshot.exists()) {
          appConfig = snapshot.val();
        } else {
          appConfig = {
            welcomeBonus: 1000,
            loanInterest: 0.30,
            initialLoanLimit: 10000,
            investmentProfitMultiplier: 1.0,
            businessProfitMultiplier: 1.0
          };
        }
        // Apply to current user if loaded
        if (currentUser) {
          applyConfigToUser();
        }
      });
    }

    // New: Apply config to user (e.g., update loanLimit if changed)
    function applyConfigToUser() {
      if (!currentUser || !appConfig) return;
      currentUser.loanLimit = appConfig.initialLoanLimit || 10000;
      updateLoanLimitDisplay();
      saveUserData(); // Persist if needed
    }

    // New: Moods listener for overrides
    function attachMoodsListener() {
      if (moodsListener) moodsListener();
      moodsListener = onValue(marketMoodsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          Object.entries(data).forEach(([id, mood]) => {
            if (moodStates[id] !== undefined) {
              previousMoods[id] = moodStates[id]; // Preserve previous for change detection
              moodStates[id] = mood;
            }
          });
          // Update UI if trading active
          if (document.getElementById('trading').classList.contains('active') && selectedAsset) {
            updateMoodDisplay(selectedAsset);
            updateTradingSuggestion();
          }
        }
      });
    }

    async function saveUserData() {
      if (currentAccount && currentUser) {
        await set(ref(db, `users/${currentAccount}`), currentUser);
      }
    }

    // Fixed addTransaction function to handle both object and multi-arg calls
    function addTransaction(...args) {
      if (!currentUser) return null;
      let transaction;
      if (args.length === 1 && typeof args[0] === 'object') {
        transaction = { ...args[0] };
      } else if (args.length >= 3) {
        const [desc, amount, type, details = ''] = args;
        transaction = {
          id: Date.now(),
          description: desc,
          amount: parseFloat(amount),
          date: new Date().toISOString(),
          type,
          details
        };
      } else {
        return null;
      }
      if (!transaction.id) transaction.id = Date.now();
      if (!transaction.date) transaction.date = new Date().toISOString();
      if (transaction.amount === undefined || transaction.amount === null) transaction.amount = 0;
      if (!currentUser.transactions) currentUser.transactions = [];
      currentUser.transactions.unshift(transaction);
      return transaction.id;
    }

    // Enhanced Complaints Functions
    function attachComplaintsListener() {
      if (complaintsListener) {
        complaintsListener();
      }
      const complaintsRef = ref(db, 'complaints');
      let firstLoad = true;
      complaintsListener = onValue(complaintsRef, async (snapshot) => {
        if (snapshot.exists()) {
          complaints = Object.values(snapshot.val()).sort((a, b) => new Date(b.date) - new Date(a.date));
        } else {
          complaints = [];
        }
        if (firstLoad) {
          firstLoad = false;
          document.getElementById('feedbackLoading').classList.add('hidden');
        }
        await renderComplaints();
      }, (error) => {
        console.error('Complaints listener error:', error);
        document.getElementById('feedbackLoading').classList.add('hidden');
      });
    }

    window.selectCategory = function(btn) {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentCategory = btn.dataset.category;
    };

    window.postComplaint = async function() {
      const text = document.getElementById('complaintText').value.trim();
      if (!text || text.length > 500 || !currentUser) {
        showNotification('Invalid feedback: Must be 1-500 characters', 'error');
        return;
      }
      const newComplaint = {
        account: currentAccount,
        category: currentCategory,
        text,
        date: new Date().toISOString(),
        likes: [],
        likeCount: 0,
        edited: false,
        adminResponse: null
      };
      const complaintsRef = ref(db, 'complaints');
      const newRef = push(complaintsRef);
      await set(newRef, { ...newComplaint, firebaseKey: newRef.key });
      document.getElementById('complaintText').value = '';
      currentCategory = 'general';
      document.querySelector('.category-btn[data-category="general"]').classList.add('active');
      logActivity('post_feedback', `Category: ${currentCategory}, Length: ${text.length}`);
      showNotification('Feedback posted successfully and visible to all users!', 'success');
    };

    window.openEditModal = function(key) {
      const post = complaints.find(c => c.firebaseKey === key);
      if (!post || post.account !== currentAccount) {
        showNotification('You can only edit your own posts', 'error');
        return;
      }
      document.getElementById('editComplaintText').value = post.text;
      document.querySelectorAll('#editCategories .category-btn').forEach(b => b.classList.remove('active'));
      const catBtn = document.querySelector(`#editCategories [data-category="${post.category}"]`);
      if (catBtn) catBtn.classList.add('active');
      currentCategory = post.category;
      editingKey = key;
      document.getElementById('editComplaintModal').style.display = 'flex';
    };

    window.updateComplaint = async function() {
      const text = document.getElementById('editComplaintText').value.trim();
      if (!text || text.length > 500) {
        showNotification('Invalid feedback: Must be 1-500 characters', 'error');
        return;
      }
      const key = editingKey;
      if (!key) return;
      const post = complaints.find(c => c.firebaseKey === key);
      if (!post) return;
      const updated = {
        ...post,
        text,
        category: currentCategory,
        edited: true,
        editDate: new Date().toISOString()
      };
      await set(ref(db, `complaints/${key}`), updated);
      closeModal('editComplaintModal');
      editingKey = null;
      logActivity('edit_feedback', `Category: ${currentCategory}, Length: ${text.length}`);
      showNotification('Feedback updated successfully!', 'success');
    };

    window.likeComplaint = async function(key) {
      if (!currentUser) return;
      const post = complaints.find(c => c.firebaseKey === key);
      if (!post) return;
      const userLiked = (post.likes || []).includes(currentAccount);
      let updatedLikes = [...(post.likes || [])];
      let updatedCount = post.likeCount;
      if (userLiked) {
        updatedLikes = updatedLikes.filter(acc => acc !== currentAccount);
        updatedCount--;
      } else {
        updatedLikes.push(currentAccount);
        updatedCount++;
      }
      await set(ref(db, `complaints/${key}`), { ...post, likes: updatedLikes, likeCount: updatedCount });
      // No need to re-render as listener will handle
      logActivity('like_feedback', `Complaint: ${key}, Action: ${userLiked ? 'unlike' : 'like'}`);
    };

    async function renderComplaints() {
      const list = document.getElementById('complaintsList');
      list.classList.remove('hidden');
      document.getElementById('feedbackLoading').classList.add('hidden');
      let filteredComplaints = complaints;
      if (filteredComplaints.length === 0) {
        list.innerHTML = '<div class="no-complaints"><i class="fas fa-comments"></i><p>No feedback yet. Be the first to share your thoughts!</p></div>';
        return;
      }
      list.innerHTML = '';
      for (let i = 0; i < filteredComplaints.length; i++) {
        const post = filteredComplaints[i];
        if (!post) continue;
        let authorObj = { name: 'Anonymous', accountNumber: post.account || 'N/A' };
        if (post.account) {
          authorObj = await loadUserIfNeeded(post.account) || { name: 'Anonymous', accountNumber: post.account };
        }
        const authorName = authorObj.name || 'Anonymous';
        const date = new Date(post.date).toLocaleString();
        const userLiked = (post.likes || []).includes(currentAccount);
        const isAuthor = post.account === currentAccount;
        const categoryClass = post.category === 'bug' ? 'danger' : post.category === 'feature' ? 'warning' : post.category === 'support' ? 'secondary' : 'primary';
        const categoryLabel = post.category.charAt(0).toUpperCase() + post.category.slice(1);
        const editedLabel = post.edited ? '<span style="color: gray; font-size: 0.7rem; margin-left: 0.5rem;">(edited)</span>' : '';
        const adminResponse = post.adminResponse ? `<div class="admin-response">
          <div class="admin-response-title">Admin Response:</div>
          <div>${post.adminResponse}</div>
        </div>` : '<div class="admin-response pending-response">Pending - Admin will respond to your message as soon as possible</div>';
        const div = document.createElement('div');
        div.classList.add('complaint-post', `category-${post.category}`);
        div.style.animationDelay = `${i * 0.1}s`;
        div.innerHTML = `
          <div class="complaint-header">
            <div class="complaint-author">
              <div class="author-avatar">${authorName.charAt(0)}</div>
              ${authorName}
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
              <span class="complaint-date">${date} ${editedLabel}</span>
              <span class="complaint-category bg-${categoryClass}">${categoryLabel}</span>
            </div>
          </div>
          <div class="complaint-text">${post.text}</div>
          ${adminResponse}
          <div class="complaint-actions">
            <button class="like-btn ${userLiked ? 'liked' : ''}" onclick="likeComplaint('${post.firebaseKey}')">
              <i class="fas fa-thumbs-up"></i> Like
              <span class="like-count">(${post.likeCount})</span>
            </button>
            ${isAuthor ? `<button class="edit-btn" onclick="openEditModal('${post.firebaseKey}')">
              <i class="fas fa-edit"></i> Edit
            </button>` : ''}
          </div>
        `;
        list.appendChild(div);
      }
    }

    async function loadUserIfNeeded(account) {
      if (!users[account]) {
        try {
          const snap = await get(ref(db, `users/${account}`));
          if (snap.exists()) {
            users[account] = snap.val();
          }
        } catch (e) {
          console.error('Error loading user:', e);
        }
      }
      return users[account];
    }

    window.switchHelpTab = function(tab, btn) {
      document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.help-section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`${tab}Section`).classList.remove('hidden');
      if (tab === 'feedback') {
        document.getElementById('feedbackLoading').classList.remove('hidden');
        renderComplaints();
      }
    };

    window.toggleAccordion = function(el) {
      el.classList.toggle('open');
      const content = el.querySelector('.accordion-content');
      content.classList.toggle('open');
      const icon = el.querySelector('.expand-icon');
      icon.classList.toggle('open');
    };

    // Sidebar Toggle
    window.toggleSidebar = function() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      sidebar.classList.toggle('open');
      mainContent.classList.toggle('expanded');
    }
    
    // Authentication Functions
    window.showLoginForm = function() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
    }
    
    window.showRegisterForm = function() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }
    
    window.login = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      await loadAllUsers();
      
      for (let acc in users) {
        if (users[acc].email === email && users[acc].password === password) {
          if (users[acc].status === 'suspended') {
            showNotification('User account suspended 🔒', 'error');
            return;
          }
          currentUser = users[acc];
          currentAccount = acc;
          localStorage.setItem('fintrust_current_account', acc);
          attachUserListener(acc);
          logActivity('login', 'User logged in');
          await showApp();
          showNotification('Login successful!', 'success');
          return;
        }
      }
      
      showNotification('Invalid email or password', 'error');
    }
    
    window.register = async function() {
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      
      if (!name || !email || !password || !confirmPassword) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
      }
      
      await loadAllUsers();
      
      let emailExists = false;
      for (let acc in users) {
        if (users[acc].email === email) {
          emailExists = true;
          break;
        }
      }
      
      if (emailExists) {
        showNotification('Email already registered', 'error');
        return;
      }
      
      // Generate 8-digit account number
      const accountNumber = generateAccountNumber();
      
      const newUser = {
        id: Date.now(),
        name: name,
        email: email,
        password: password,
        accountNumber: accountNumber,
        balance: 0,
        loanLimit: appConfig.initialLoanLimit || 10000,
        investments: [],
        tradingPortfolio: [],
        tradeHistory: [],
        transactions: [],
        loans: [],
        businesses: [],
        walletPin: null,
        notifications: {
          email: true,
          sms: false,
          alerts: true
        },
        preferences: {
          currency: 'USD',
          language: 'en'
        },
        status: 'active' // New: Default status
      };
      
      await set(ref(db, `users/${accountNumber}`), newUser);
      
      currentUser = newUser;
      currentAccount = accountNumber;
      localStorage.setItem('fintrust_current_account', accountNumber);
      attachUserListener(accountNumber);
      logActivity('register', `New user registered: ${accountNumber}`);
      
      await showApp();
      showNotification('Account created successfully!', 'success');
    }
    
    window.logout = async function() {
      logActivity('logout', 'User logged out');
      if (window.marketInterval) {
        clearInterval(window.marketInterval);
        window.marketInterval = null;
      }
      if (userListener) {
        userListener();
        userListener = null;
      }
      if (complaintsListener) {
        complaintsListener();
        complaintsListener = null;
      }
      if (configListener) {
        configListener();
        configListener = null;
      }
      if (moodsListener) {
        moodsListener();
        moodsListener = null;
      }
      currentUser = null;
      currentAccount = null;
      localStorage.removeItem('fintrust_current_account');
      showAuth();
      showNotification('You have been logged out', 'success');
    }
    
    function generateAccountNumber() {
      // Generate 8-digit account number
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }
    
    async function findUserByAccount(accountNumber) {
      await loadAllUsers();
      return users[accountNumber] || null;
    }
    
    // Load Settings
    function loadSettings() {
      if (currentUser.notifications) {
        document.getElementById('emailNotifications').checked = currentUser.notifications.email;
        document.getElementById('smsNotifications').checked = currentUser.notifications.sms;
        document.getElementById('transactionAlerts').checked = currentUser.notifications.alerts;
      }
      if (currentUser.preferences) {
        document.getElementById('currencySelect').value = currentUser.preferences.currency;
        document.getElementById('languageSelect').value = currentUser.preferences.language;
      }
    }
    
    // Update Profile
    window.updateProfile = async function() {
      const name = document.getElementById('profileName').value;
      const email = document.getElementById('profileEmail').value;
      
      if (!name || !email) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Check if email is already taken by another user
      await loadAllUsers();
      let emailExists = false;
      for (let acc in users) {
        if (users[acc].email === email && acc !== currentAccount) {
          emailExists = true;
          break;
        }
      }
      
      if (emailExists) {
        showNotification('Email already registered by another user', 'error');
        return;
      }
      
      currentUser.name = name;
      currentUser.email = email;
      
      // Update UI
      document.getElementById('userName').textContent = name;
      document.getElementById('userAvatar').textContent = name.charAt(0);
      document.getElementById('profileAvatar').textContent = name.charAt(0);
      
      await saveUserData();
      logActivity('profile_update', `Name: ${name}, Email: ${email}`);
      showNotification('Profile updated successfully!', 'success');
    }
    
    // Update Password
    window.updatePassword = async function() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      
      if (!currentPassword || !newPassword || !confirmNewPassword) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      if (currentPassword !== currentUser.password) {
        showNotification('Current password is incorrect', 'error');
        return;
      }
      
      if (newPassword !== confirmNewPassword) {
        showNotification('New passwords do not match', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        showNotification('New password must be at least 6 characters', 'error');
        return;
      }
      
      currentUser.password = newPassword;
      await saveUserData();
      logActivity('change_password', 'Password changed');
      showNotification('Password updated successfully!', 'success');
      
      // Clear fields
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
    }
    
    // Save Notifications
    window.saveNotifications = async function() {
      const email = document.getElementById('emailNotifications').checked;
      const sms = document.getElementById('smsNotifications').checked;
      const alerts = document.getElementById('transactionAlerts').checked;
      
      currentUser.notifications = { email, sms, alerts };
      await saveUserData();
      logActivity('update_notifications', `Email: ${email}, SMS: ${sms}, Alerts: ${alerts}`);
      showNotification('Notification preferences saved!', 'success');
    }
    
    // Save Preferences
    window.savePreferences = async function() {
      const currency = document.getElementById('currencySelect').value;
      const language = document.getElementById('languageSelect').value;
      
      currentUser.preferences = { currency, language };
      await saveUserData();
      logActivity('update_preferences', `Currency: ${currency}, Language: ${language}`);
      showNotification('Preferences saved! Note: Currency and language changes will apply on next login.', 'success');
    }
    
    window.showAuth = function() {
      document.getElementById('authContainer').classList.remove('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }
    
    async function showApp() {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      
      // Update UI with user info
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
      document.getElementById('profileAvatar').textContent = currentUser.name.charAt(0);
      document.getElementById('profileName').value = currentUser.name;
      document.getElementById('profileEmail').value = currentUser.email;
      document.getElementById('profileAccountNumber').textContent = currentUser.accountNumber;
      document.getElementById('accountNumberDisplay').textContent = currentUser.accountNumber;
      
      // Load settings
      loadSettings();
      await loadAllUsers();
      
      // Add welcome bonus if no transactions
      if (currentUser.transactions.length === 0) {
        const bonus = appConfig.welcomeBonus || 1000;
        currentUser.balance += bonus;
        addTransaction({
          id: Date.now(), 
          description: "Welcome Bonus", 
          amount: bonus, 
          date: new Date().toISOString(),
          type: 'bonus'
        });
        await saveUserData();
      }
      
      // Initialize trading market
      initTradingMarket();
      
      // Initialize charts and data
      renderAssets();
      renderBusinessOptions();
      await updateDashboard();
      await updateWallet();
      await renderTransactions();
      await renderInvestments();
      await renderLoans();
      await renderBusinesses();
      initCharts();
      updateLoanLimitDisplay();
      attachComplaintsListener(); // Attach complaints listener on app load
    }
    
    // Trading Market Initialization with Firebase sync
    function initTradingMarket() {
      tradingAssets.forEach(asset => {
        marketPrices[asset.id] = asset.basePrice;
        prevPrices[asset.id] = asset.basePrice;
        marketHistory[asset.id] = {
          candles: [{
            open: asset.basePrice,
            high: asset.basePrice,
            low: asset.basePrice,
            close: asset.basePrice,
            volume: Math.random() * 1000 + 500,
            timestamp: Date.now()
          }]
        };
        moodStates[asset.id] = 'Stable';
        previousMoods[asset.id] = 'Stable';
        momentums[asset.id] = 0;
        currentSentiments[asset.id] = 0;
      });
      // Initial sync to Firebase
      set(marketPricesRef, marketPrices).catch(console.error);

      // Real-time listener for market prices
      onValue(marketPricesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          Object.entries(data).forEach(([id, price]) => {
            if (marketPrices[id] !== undefined) {
              prevPrices[id] = marketPrices[id];
              marketPrices[id] = price;
              // Update last candle if exists
              if (marketHistory[id] && marketHistory[id].candles.length > 0) {
                marketHistory[id].candles[marketHistory[id].candles.length - 1].close = price;
              }
            }
          });
          // Update UI if trading tab is active
          if (document.getElementById('trading').classList.contains('active')) {
            updateTradingSummary();
            if (selectedAsset && marketPrices[selectedAsset]) {
              updateAssetDisplay(selectedAsset);
            }
          }
        }
      });

      // New: Attach moods listener
      attachMoodsListener();

      if (!window.marketInterval) {
        window.marketInterval = setInterval(updateMarket, 9000);
      }
    }
    
    // Simulate News Sentiment (In real implementation, use web_search or x_keyword_search tools)
    function getNewsSentiment(assetId) {
      const polarities = {
        BTC: { pos: 0.7, neg: 0.2, neu: 0.1 },
        ETH: { pos: 0.35, neg: 0.35, neu: 0.3 },
        XAU: { pos: 0.3, neg: 0.25, neu: 0.45 },
        XAG: { pos: 0.3, neg: 0.3, neu: 0.4 },
        OIL: { pos: 0.25, neg: 0.4, neu: 0.35 },
        DIA: { pos: 0.3, neg: 0.2, neu: 0.5 },
        GBP: { pos: 0.3, neg: 0.3, neu: 0.4 },
        EUR: { pos: 0.3, neg: 0.3, neu: 0.4 },
        NGN: { pos: 0.3, neg: 0.3, neu: 0.4 }
      };
      const p = polarities[assetId] || { pos: 0.33, neg: 0.33, neu: 0.34 };
      const r = Math.random();
      if (r < p.pos) return Math.random() * 0.4 + 0.6;
      if (r < p.pos + p.neg) return -(Math.random() * 0.4 + 0.6);
      return Math.random() * 0.4 - 0.2;
    }
    
    // Update Market Simulation with Enhanced AI Mood Engine (10 Moods)
    function updateMarket() {
      updateCount++;
      let eventTriggered = false;
      tradingAssets.forEach(asset => {
        const id = asset.id;
        const prevClose = marketPrices[id];
        
        // Real-time Event Integration: Fetch news sentiment every 3 updates
        if (updateCount % 3 === 0) {
          const news_sent = getNewsSentiment(id);
          const candles = marketHistory[id].candles;
          let previous_trend = 0;
          if (candles.length >= 5) {
            const recent = candles.slice(-5).map(c => (c.close - c.open) / c.open);
            previous_trend = recent.reduce((a, b) => a + b, 0) / recent.length;
          }
          const rand_bias = Math.random() * 0.6 - 0.3;
          const sentiment = rand_bias + (news_sent * 0.7) + (previous_trend * 0.2);
          currentSentiments[id] = sentiment;
          
          // Enhanced Mood Determination with 10 Moods (Stable as existing, 9 additional)
          let mood;
          // Check for Volatile (frustrating fluctuations)
          let isVolatile = false;
          if (candles.length >= 10) {
            const recent = candles.slice(-10);
            const recentChanges = recent.map(c => (c.close - c.open) / c.open);
            const meanChange = recentChanges.reduce((a, b) => a + b, 0) / recentChanges.length;
            const variance = recentChanges.reduce((sum, ch) => sum + Math.pow(ch - meanChange, 2), 0) / recentChanges.length;
            const stdDev = Math.sqrt(variance);
            if (stdDev > 0.05 && Math.abs(sentiment) < 0.1) {
              mood = 'Volatile';
              isVolatile = true;
            }
          }
          if (!isVolatile) {
            if (sentiment > 0.8) mood = 'Boom';
            else if (sentiment > 0.6) mood = 'Euphoric';
            else if (sentiment > 0.3) mood = 'Bullish';
            else if (sentiment > 0.1) mood = 'Optimistic';
            else if (sentiment > -0.1) mood = 'Stable';
            else if (sentiment > -0.3) mood = 'Cautious';
            else if (sentiment > -0.6) mood = 'Bearish';
            else if (sentiment > -0.8) mood = 'Panic';
            else mood = 'Crash';
          }
          // New: Check for override mood first
          const overrideMood = moodStates[id]; // From listener
          if (overrideMood && overrideMood !== 'Auto') {
            mood = overrideMood;
          } else {
            moodStates[id] = mood;
          }
        }
        
        const sentiment = currentSentiments[id] || 0;
        const mood = moodStates[id];
        
        // Enhanced Mood Multiplier for 10 Moods
        let moodMultiplier;
        switch (mood) {
          case 'Boom': moodMultiplier = Math.random() * 0.4 + 1.6; break; // 1.6-2.0: Big gains
          case 'Euphoric': moodMultiplier = Math.random() * 0.3 + 1.3; break; // 1.3-1.6: Strong rise
          case 'Bullish': moodMultiplier = Math.random() * 0.15 + 1.15; break; // 1.15-1.3: Positive rise
          case 'Optimistic': moodMultiplier = Math.random() * 0.07 + 1.05; break; // 1.05-1.12: Mild positive
          case 'Stable': moodMultiplier = Math.random() * 0.04 + 0.98; break; // 0.98-1.02: Balanced/maintain
          case 'Cautious': moodMultiplier = Math.random() * 0.07 + 0.93; break; // 0.93-1.0: Mild depreciate
          case 'Bearish': moodMultiplier = Math.random() * 0.15 + 0.85; break; // 0.85-1.0: Steady depreciate
          case 'Panic': moodMultiplier = Math.random() * 0.2 + 0.5; break; // 0.5-0.7: Sharp drop
          case 'Crash': moodMultiplier = Math.random() * 0.2 + 0.01; break; // 0.01-0.21: Complete loss potential
          case 'Volatile': moodMultiplier = Math.random() * 0.05 + 0.98; break; // 0.98-1.03: Fluctuating (vola amplified below)
          default: moodMultiplier = 1;
        }
        
        // Asset-specific Volatility Factor (amplified for Volatile)
        let volaFactor;
        switch (id) {
          case 'BTC':
          case 'ETH':
            volaFactor = Math.random() * 0.20 + 1.0; break;
          case 'OIL':
            volaFactor = Math.random() * 0.25 + 0.9; break;
          case 'XAG':
            volaFactor = Math.random() * 0.15 + 0.95; break;
          case 'XAU':
            volaFactor = Math.random() * 0.10 + 0.98; break;
          case 'DIA':
            volaFactor = Math.random() * 0.08 + 0.97; break;
          case 'GBP':
          case 'EUR':
            volaFactor = Math.random() * 0.03 + 0.99; break;
          case 'NGN':
            volaFactor = Math.random() * 0.05 + 0.98; break;
          default:
            volaFactor = 1;
        }
        if (mood === 'Volatile') {
          volaFactor *= 2.5; // Amplify volatility for frustrating swings
        }
        
        // Base Change % with pseudo-random probability
        let baseChange = Math.random() * 0.045 + 0.005; // 0.5% to 5%
        if (Math.random() < 0.1) baseChange = Math.random() * 0.15 + 0.05; // Up to 20% on events
        
        const momentum = momentums[id] || 0;
        const direction = sentiment > 0 ? 1 : (sentiment < 0 ? -1 : (Math.random() > 0.5 ? 1 : -1));
        let changePercent = direction * baseChange * moodMultiplier * volaFactor * (1 + sentiment) * (1 + momentum);
        
        // Clamp changes (allow larger for extremes)
        if (mood === 'Boom' || mood === 'Crash') {
          changePercent = Math.max(-0.5, Math.min(0.5, changePercent)); // Up to 50% swings
        } else {
          changePercent = Math.max(-0.25, Math.min(0.25, changePercent));
        }
        
        // Update momentum with decaying/amplifying effects
        momentums[id] = momentums[id] * 0.9 + sentiment * volaFactor;
        
        // Compute new price
        const newPrice = prevClose * (1 + changePercent);
        
        // Generate candle with volatility-based wicks
        const vola = Math.abs(changePercent) + 0.005;
        const randHigh = prevClose * vola * Math.random();
        const randLow = prevClose * vola * Math.random();
        const high = Math.max(prevClose, newPrice, prevClose + randHigh, newPrice + randHigh);
        const low = Math.min(prevClose, newPrice, prevClose - randLow, newPrice - randLow);
        const volume = (Math.random() * 1000 + 500) * (1 + Math.abs(changePercent) * 20);
        
        marketHistory[id].candles.push({
          open: prevClose,
          high,
          low,
          close: newPrice,
          volume,
          timestamp: Date.now()
        });
        
        // Keep last 200 candles
        if (marketHistory[id].candles.length > 200) {
          marketHistory[id].candles.shift();
        }
        
        marketPrices[id] = Math.max(newPrice, 0.01); // Prevent zero price for fiat safety
        prevPrices[id] = prevClose;

        // Crash Mood Handling: Immediately wipe user's positions in this asset to $0 permanently
        if (mood === 'Crash' && previousMoods[id] !== 'Crash') {
          const position = currentUser.tradingPortfolio.find(p => p.id === id);
          if (position && position.units > 0.0001) {
            const loss = -position.totalCostUSD;
            // Force sell at $0, no recovery possible since units set to 0
            position.units = 0;
            position.totalCostUSD = 0;
            // Remove from portfolio
            currentUser.tradingPortfolio = currentUser.tradingPortfolio.filter(p => p.units > 0.0001);
            // Record the loss transaction
            addTransaction(`CRASH: ${asset.name} positions wiped out to $0 (permanent loss)`, loss, 'trade');
            // Add to tradeHistory as crash event
            const tradeEntry = {
              id: Date.now(),
              type: 'crash',
              assetId: id,
              units: 0,
              price: 0,
              totalUSD: loss,
              profit: loss,
              timestamp: new Date().toISOString(),
              description: `CRASH: ${asset.name} positions wiped out to $0 (permanent loss)`
            };
            if (!currentUser.tradeHistory) currentUser.tradeHistory = [];
            currentUser.tradeHistory.unshift(tradeEntry);
            currentUser.tradeHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            // Save immediately
            saveUserData();
            // Notify user
            showNotification(`CRASH ALERT: All ${asset.name} trading positions lost permanently! Total loss: $${Math.abs(loss).toFixed(2)}. Value locked at $0 even after mood changes.`, 'error');
            // Update UI immediately
            updateTradingSummary();
            renderTradingPortfolio();
            renderTradingHistory();
          }
        }
        previousMoods[id] = mood;
        
        // Event-Driven Behavior Injection with Mood-Specific Alerts
        if (Math.abs(changePercent) > 0.05 && Math.random() < 0.2) {
          let eventMsg;
          if (changePercent > 0.2 && (mood === 'Boom' || mood === 'Euphoric')) {
            eventMsg = `Market Boom Alert! ${asset.name} surges +${(changePercent * 100).toFixed(1)}% - Massive gains opportunity!`;
          } else if (changePercent < -0.2 && (mood === 'Crash' || mood === 'Panic')) {
            eventMsg = `Crash Warning! ${asset.name} plummets -${(Math.abs(changePercent) * 100).toFixed(1)}% - Total loss risk, sell now!`;
          } else if (mood === 'Volatile') {
            eventMsg = `Volatile Market: ${asset.name} swings wildly - Frustrating conditions, hold or hedge.`;
          } else if (changePercent > 0) {
            eventMsg = `Breaking: ${asset.name} rallies +${(changePercent * 100).toFixed(1)}% amid positive sentiment!`;
          } else {
            eventMsg = `${asset.name} faces pressure, down -${(Math.abs(changePercent) * 100).toFixed(1)}% on bearish news.`;
          }
          showNotification(eventMsg, changePercent > 0 ? 'success' : 'error');
        }
      });
      
      // Sync prices to Firebase periodically
      if (updateCount % 5 === 0) {
        set(marketPricesRef, marketPrices).catch(console.error);
      }
      
      // Always update summary for real-time P/L
      updateTradingSummary();
      
      // Update UI if trading tab is active
      if (document.getElementById('trading').classList.contains('active')) {
        if (selectedAsset) {
          updateAssetDisplay(selectedAsset);
          updateMoodDisplay(selectedAsset);
          renderTradingChart(selectedAsset, currentTimeframe);
          updateTradingSuggestion();
        }
        renderTradingPortfolio();
        renderTradingHistory();
        populateTradeFrom();
      }
    }
    
    function updateMoodDisplay(assetId) {
      const moodEl = document.getElementById('currentMood');
      const mood = moodStates[assetId];
      const className = mood.toLowerCase();
      moodEl.innerHTML = `Mood: <span class="mood-${className}">${mood}</span>`;
    }
    
    function updateTradingSuggestion() {
      const mood = moodStates[selectedAsset];
      let suggestion;
      switch (mood) {
        case 'Boom':
          suggestion = 'Extreme Buy - Massive rally underway, huge gains possible!'; break;
        case 'Euphoric':
          suggestion = 'Strong Buy - Euphoric sentiment, significant rise expected.'; break;
        case 'Bullish':
          suggestion = 'Buy - Bullish trend, positive gains likely.'; break;
        case 'Optimistic':
          suggestion = 'Mild Buy - Optimistic mood, steady appreciation.'; break;
        case 'Stable':
          suggestion = 'Hold - Stable market, balanced conditions.'; break;
        case 'Cautious':
          suggestion = 'Hold/Sell Partial - Cautious sentiment, mild depreciation risk.'; break;
        case 'Bearish':
          suggestion = 'Sell - Bearish pressure, steady depreciation.'; break;
        case 'Panic':
          suggestion = 'Sell Now - Panic selling, sharp drops imminent.'; break;
        case 'Crash':
          suggestion = 'Emergency Sell - Market crash, liquidate to avoid total loss! Positions may be wiped to $0 permanently.'; break;
        case 'Volatile':
          suggestion = 'Caution - High volatility, frustrating swings; hedge or wait.'; break;
        default:
          suggestion = 'Analyzing...';
      }
      const className = mood.toLowerCase();
      document.getElementById('tradingSuggestion').innerHTML = `<span class="mood-${className}">${suggestion}</span>`;
    }
    
    // Update Trading UI
    function updateTradingUI() {
      updateTradingSummary();
      if (selectedAsset) {
        updateAssetDisplay(selectedAsset);
        updateMoodDisplay(selectedAsset);
        renderTradingChart(selectedAsset, currentTimeframe);
        updateTradingSuggestion();
      }
      renderTradingPortfolio();
      renderTradingHistory();
      populateTradeFrom();
      updateSellSection(selectedAsset);
    }
    
    // Trading Functions
    function initTrading() {
      updateTradingUI();
    }
    
    window.changeAsset = function(assetId) {
      selectedAsset = assetId;
      const asset = tradingAssets.find(a => a.id === assetId);
      document.getElementById('currentAssetName').textContent = `${asset.name} (${asset.unit})`;
      updateAssetDisplay(assetId);
      updateMoodDisplay(assetId);
      renderTradingChart(assetId, currentTimeframe);
      updateTradingSuggestion();
      updateSellSection(assetId);
      populateTradeFrom();
    }
    
    function updateAssetDisplay(assetId) {
      const price = marketPrices[assetId];
      const prev = prevPrices[assetId];
      const change = ((price - prev) / prev * 100);
      const asset = tradingAssets.find(a => a.id === assetId);
      if (asset.isFiat) {
        document.getElementById('currentPrice').textContent = `1 USD = ${price.toLocaleString(undefined, {maximumFractionDigits: 0})} ${asset.unit}`;
      } else {
        document.getElementById('currentPrice').textContent = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      }
      const changeEl = document.getElementById('priceChange');
      changeEl.innerHTML = `${change > 0 ? '+' : ''}${change.toFixed(2)}% <i class="${change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'}"></i>`;
      changeEl.className = `trading-price-change ${change >= 0 ? 'price-change-positive' : 'price-change-negative'}`;
    }
    
    window.setTimeframe = function(tf, btn) {
      currentTimeframe = tf;
      document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (selectedAsset) {
        renderTradingChart(selectedAsset, tf);
      }
    }
    
    // Calculate Simple Moving Average (SMA 20)
    function calculateSMA(candles, period = 20) {
      const sma = [];
      for (let i = 0; i < candles.length; i++) {
        if (i < period - 1) {
          sma.push(null);
        } else {
          const slice = candles.slice(i - period + 1, i + 1);
          const avg = slice.reduce((sum, c) => sum + c.close, 0) / period;
          sma.push({ x: candles[i].timestamp, y: avg });
        }
      }
      return sma;
    }
    
    function renderTradingChart(assetId, tf) {
      const data = marketHistory[assetId];
      if (!data || data.candles.length < 2) return;
      
      let numCandles = 50;
      if (tf === '1d') numCandles = 50;
      else if (tf === '1h') numCandles = 30;
      else if (tf === '5m') numCandles = 20;
      else numCandles = 50;
      
      const candles = data.candles.slice(-numCandles);
      const smaData = calculateSMA(candles);
      
      const ctx = document.getElementById('tradingChart').getContext('2d');
      if (tradingChart) tradingChart.destroy();
      
      const asset = tradingAssets.find(a => a.id === assetId);
      tradingChart = new Chart(ctx, {
        data: {
          datasets: [{
            type: 'line',
            label: `${asset.name} Price (Close)`,
            data: candles.map(candle => ({
              x: candle.timestamp,
              y: candle.close
            })),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true,
            pointRadius: 2
          }, {
            type: 'line',
            label: 'SMA (20)',
            data: smaData,
            borderColor: 'rgba(255, 193, 7, 1)',
            backgroundColor: 'rgba(255, 193, 7, 0.2)',
            fill: false,
            tension: 0.1,
            yAxisID: 'y',
            borderDash: [5, 5],
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: tf === '1m' ? 'second' : tf === '5m' ? 'minute' : tf === '1h' ? 'hour' : 'day'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            },
            y: {
              type: 'linear',
              position: 'left',
              beginAtZero: false,
              grid: {
                color: 'rgba(0,0,0,0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }
    
    window.exportTradingChart = function() {
      const chartContainer = document.querySelector('#trading .chart-container');
      html2canvas(chartContainer).then(canvas => {
        const link = document.createElement('a');
        link.download = `trading-chart-${selectedAsset}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showNotification('Chart exported successfully!', 'success');
      });
    }
    
    function populateTradeFrom() {
      const select = document.getElementById('tradeFromSelect');
      // Keep wallet option, remove others
      select.innerHTML = '<option value="wallet">Wallet (USD)</option>';
      (currentUser.tradingPortfolio || []).forEach(pos => {
        if (pos.id === selectedAsset) return;
        const asset = tradingAssets.find(a => a.id === pos.id);
        const opt = new Option(`${asset.name} (${pos.units.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit})`, pos.id);
        select.appendChild(opt);
      });
    }
    
    window.executeBuy = async function() {
      const amount = parseFloat(document.getElementById('buyAmount').value);
      if (!amount || amount <= 0) {
        showNotification('Invalid amount', 'error');
        return;
      }
      const fromId = document.getElementById('tradeFromSelect').value;
      let success = false;
      if (fromId === 'wallet') {
        if (currentUser.balance < amount) {
          showNotification('Insufficient wallet balance', 'error');
          return;
        }
        success = buyTrade(selectedAsset, amount);
      } else {
        if (fromId === selectedAsset) {
          showNotification('Cannot convert asset to itself', 'error');
          return;
        }
        const fromAssetObj = tradingAssets.find(a => a.id === fromId);
        const currentPriceFrom = marketPrices[fromId];
        const positionFrom = (currentUser.tradingPortfolio || []).find(p => p.id === fromId);
        const valueUSDFrom = fromAssetObj.isFiat ? positionFrom.units / currentPriceFrom : positionFrom.units * currentPriceFrom;
        if (valueUSDFrom < amount) {
          showNotification('Insufficient value in selected asset', 'error');
          return;
        }
        const unitsToSellFrom = fromAssetObj.isFiat ? amount * currentPriceFrom : amount / currentPriceFrom;
        success = sellTrade(fromId, unitsToSellFrom) && buyTrade(selectedAsset, amount);
        if (success) {
          const toAssetObj = tradingAssets.find(a => a.id === selectedAsset);
          addTransaction(`Converted ${fromAssetObj.name} to ${toAssetObj.name} (${amount.toFixed(2)} USD)`, 0, 'conversion');
          await saveUserData();
        }
      }
      if (success) {
        document.getElementById('buyAmount').value = '';
        await updateWallet();
        renderTradingPortfolio();
        const assetName = tradingAssets.find(a => a.id === selectedAsset).name;
        logActivity('buy_trade', `${assetName} for $${amount.toFixed(2)}`);
        showNotification(`Successfully traded ${amount.toFixed(2)} USD worth of ${assetName}`, 'success');
        await saveUserData();
      }
    }
    
    window.executeSell = async function() {
      const units = parseFloat(document.getElementById('sellUnits').value);
      if (!units || units <= 0) {
        showNotification('Invalid units', 'error');
        return;
      }
      const position = (currentUser.tradingPortfolio || []).find(p => p.id === selectedAsset);
      if (!position || position.units < units) {
        showNotification('Insufficient units', 'error');
        return;
      }
      // Immediate sell
      if (sellTrade(selectedAsset, units)) {
        document.getElementById('sellUnits').value = '';
        await updateWallet();
        renderTradingPortfolio();
        const assetName = tradingAssets.find(a => a.id === selectedAsset).name;
        logActivity('sell_trade', `${assetName} ${units.toLocaleString(undefined, {maximumFractionDigits: 4})} units`);
        showNotification(`Immediately sold ${units.toLocaleString(undefined, {maximumFractionDigits: 4})} units of ${assetName}`, 'success');
        await saveUserData();
      }
    }
    
    function buyTrade(assetId, amountUSD) {
      const asset = tradingAssets.find(a => a.id === assetId);
      const currentPrice = marketPrices[assetId];
      if (currentUser.balance < amountUSD) return false;
      
      let units;
      if (asset.isFiat) {
        units = amountUSD * currentPrice;
      } else {
        units = amountUSD / currentPrice;
      }
      
      currentUser.balance -= amountUSD;
      
      let position = (currentUser.tradingPortfolio || []).find(p => p.id === assetId);
      if (position) {
        position.units += units;
        position.totalCostUSD += amountUSD;
      } else {
        if (!currentUser.tradingPortfolio) currentUser.tradingPortfolio = [];
        currentUser.tradingPortfolio.push({
          id: assetId,
          units: units,
          totalCostUSD: amountUSD,
          buyDate: new Date().toISOString()
        });
      }
      
      addTransaction(`Bought ${asset.name} (${units.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit})`, -amountUSD, 'trade');
      const tradeEntry = {
        id: Date.now(),
        type: 'buy',
        assetId: assetId,
        units: units,
        price: currentPrice,
        totalUSD: amountUSD,
        timestamp: new Date().toISOString()
      };
      if (!currentUser.tradeHistory) currentUser.tradeHistory = [];
      currentUser.tradeHistory.unshift(tradeEntry);
      return true;
    }
    
    function sellTrade(assetId, sellUnits) {
      const position = (currentUser.tradingPortfolio || []).find(p => p.id === assetId);
      if (!position || position.units < sellUnits) return false;
      
      const asset = tradingAssets.find(a => a.id === assetId);
      const currentPrice = marketPrices[assetId];
      const valueUSD = asset.isFiat ? sellUnits / currentPrice : sellUnits * currentPrice;
      
      const avgCostPerUnit = position.totalCostUSD / position.units;
      const costSold = sellUnits * avgCostPerUnit;
      const profit = valueUSD - costSold;
      
      currentUser.balance += valueUSD;
      position.units -= sellUnits;
      position.totalCostUSD -= costSold;
      
      if (position.units < 0.0001) {
        const idx = currentUser.tradingPortfolio.indexOf(position);
        currentUser.tradingPortfolio.splice(idx, 1);
      }
      
      addTransaction(`Sold ${asset.name} (${sellUnits.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit}, P/L: $${profit.toFixed(2)})`, valueUSD, 'trade');
      const tradeEntry = {
        id: Date.now(),
        type: 'sell',
        assetId: assetId,
        units: sellUnits,
        price: currentPrice,
        totalUSD: valueUSD,
        profit: profit,
        timestamp: new Date().toISOString()
      };
      if (!currentUser.tradeHistory) currentUser.tradeHistory = [];
      currentUser.tradeHistory.unshift(tradeEntry);
      return true;
    }
    
    function updateSellSection(assetId) {
      const position = (currentUser.tradingPortfolio || []).find(p => p.id === assetId);
      const sellSection = document.getElementById('sellSection');
      const sellLabel = document.getElementById('sellLabel');
      const asset = tradingAssets.find(a => a.id === assetId);
      if (position && position.units > 0) {
        sellSection.classList.remove('hidden');
        sellLabel.textContent = `${asset.name} to Sell`;
        document.getElementById('sellUnits').placeholder = `Max: ${position.units.toLocaleString(undefined, {maximumFractionDigits: 4})}`;
      } else {
        sellSection.classList.add('hidden');
      }
    }
    
    // Fixed helper for sell all
    window.executeSellAll = function(assetId, units) {
      changeAsset(assetId);
      setTimeout(() => {
        document.getElementById('sellUnits').value = units.toFixed(6);
        executeSell();
      }, 100);
    }
    
    // Update Trading Summary - Current unsold positions only
    function updateTradingSummary() {
      let totalValue = 0;
      let totalPL = 0;
      let totalCost = 0;
      let activePositions = 0;
      (currentUser.tradingPortfolio || []).forEach(pos => {
        if (pos.units > 0.0001) { // Only unsold
          activePositions++;
          const asset = tradingAssets.find(a => a.id === pos.id);
          const currentPrice = marketPrices[pos.id];
          const currentValue = asset.isFiat ? pos.units / currentPrice : pos.units * currentPrice;
          totalValue += currentValue;
          totalPL += (currentValue - pos.totalCostUSD);
          totalCost += pos.totalCostUSD;
        }
      });
      
      document.getElementById('tradingTotalValue').textContent = `$${totalValue.toFixed(2)}`;
      const pl = totalPL;
      const plPct = totalCost > 0 ? ((pl / totalCost) * 100).toFixed(1) : 0;
      const plEl = document.getElementById('tradingPL');
      plEl.innerHTML = `$${pl.toFixed(2)} <span class="profit-indicator ${pl >= 0 ? 'profit-positive' : 'profit-negative'}">${pl >= 0 ? '+' : ''}${plPct}%</span>`;
      document.getElementById('totalTrades').textContent = activePositions;
    }
    
    function renderTradingPortfolio() {
      const list = document.getElementById('tradingPortfolioList');
      if ((currentUser.tradingPortfolio || []).filter(p => p.units > 0.0001).length === 0) {
        list.innerHTML = '<p class="text-center">No positions yet. Start trading!</p>';
        return;
      }
      
      list.innerHTML = '';
      (currentUser.tradingPortfolio || []).forEach(pos => {
        if (pos.units <= 0.0001) return; // Only unsold
        const asset = tradingAssets.find(a => a.id === pos.id);
        const currentPrice = marketPrices[pos.id];
        const currentValue = asset.isFiat ? pos.units / currentPrice : pos.units * currentPrice;
        const pl = currentValue - pos.totalCostUSD;
        const plPct = ((pl / pos.totalCostUSD) * 100).toFixed(1);
        
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">${asset.name} (${pos.units.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit})</div>
            <div class="list-item-detail">Cost: $${pos.totalCostUSD.toFixed(2)}</div>
            <div class="list-item-detail">Value: $${currentValue.toFixed(2)} 
              <span class="profit-indicator ${pl >= 0 ? 'profit-positive' : 'profit-negative'}">
                ${pl >= 0 ? '+' : ''}${plPct}%
              </span>
            </div>
          </div>
          <div class="list-actions">
            <button class="btn btn-danger" onclick="executeSellAll('${pos.id}', ${pos.units})">Sell All</button>
          </div>
        `;
        list.appendChild(li);
      });
    }
    
    function renderTradingHistory() {
      const list = document.getElementById('tradingHistoryList');
      const trades = (currentUser.tradeHistory || []).slice(0, 10);
      if (trades.length === 0) {
        list.innerHTML = '<p class="text-center">No trades yet.</p>';
        return;
      }
      list.innerHTML = '';
      trades.forEach(trade => {
        const asset = tradingAssets.find(a => a.id === trade.assetId);
        if (!asset) return;
        const amountClass = trade.type === 'buy' ? 'transaction-negative' : 'transaction-positive';
        const sign = trade.type === 'buy' ? '-' : '+';
        let liHTML = '';
        let isCrash = trade.type === 'crash';
        if (isCrash) {
          liHTML = `
            <div class="list-item crash-trade" data-trade-id="${trade.id}">
              <div class="list-item-content">
                <div class="list-item-title">
                  <i class="fas fa-exclamation-triangle crash-icon"></i>
                  ${trade.description}
                </div>
                <div class="list-item-detail">Loss: $${Math.abs(trade.totalUSD).toFixed(2)}</div>
                <div class="list-item-detail">${new Date(trade.timestamp).toLocaleString()}</div>
              </div>
              <div class="list-actions">
                <button class="btn btn-outline" onclick="showTradeReceipt('${trade.id}')">
                  <i class="fas fa-receipt"></i> Receipt
                </button>
              </div>
            </div>
          `;
        } else {
          liHTML = `
            <div class="list-item" data-trade-id="${trade.id}">
              <div class="list-item-content">
                <div class="list-item-title">${trade.type.toUpperCase()} ${asset.name} (${trade.units.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit})</div>
                <div class="list-item-detail">Price: $${trade.price.toFixed(2)} | Total: ${sign}$${Math.abs(trade.totalUSD).toFixed(2)}</div>
                ${trade.type === 'sell' ? `<div class="list-item-detail">P/L: $${trade.profit.toFixed(2)}</div>` : ''}
                <div class="list-item-detail">${new Date(trade.timestamp).toLocaleString()}</div>
              </div>
              <div class="${amountClass}">${sign}$${Math.abs(trade.totalUSD).toFixed(2)}</div>
            </div>
          `;
        }
        list.insertAdjacentHTML('beforeend', liHTML);
      });
    }

    window.showTradeReceipt = function(tradeId) {
      const trade = (currentUser.tradeHistory || []).find(t => t.id === parseInt(tradeId));
      if (!trade || trade.type !== 'crash') return;
      const asset = tradingAssets.find(a => a.id === trade.assetId);
      const receiptId = 'TT-' + Math.floor(100000000 + Math.random() * 900000000);
      const now = new Date(trade.timestamp);
      const dateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      
      document.getElementById('tradeReceiptId').textContent = receiptId;
      document.getElementById('tradeReceiptDateTime').textContent = dateTime;
      document.getElementById('tradeReceiptAccount').textContent = currentUser.accountNumber;
      document.getElementById('tradeReceiptAsset').textContent = asset ? asset.name + ' (' +asset.unit + ')' : 'Unknown';
      document.getElementById('tradeReceiptType').textContent = 'Market Crash Wipeout';
      document.getElementById('tradeReceiptDescription').textContent = trade.description;
      document.getElementById('tradeReceiptAmount').textContent = `$${trade.totalUSD.toFixed(2)}`;
      
      document.getElementById('tradeReceiptContent').classList.add('crash-receipt');
      document.getElementById('tradeReceiptModal').style.display = 'flex';
    }

    window.downloadTradeReceipt = function() {
      const receipt = document.getElementById('tradeReceiptContent');
      
      html2canvas(receipt).then(canvas => {
        const link = document.createElement('a');
        link.download = 'fintrust-trade-receipt.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
    
    function showTradeDetail(tradeId) {
      const trade = (currentUser.tradeHistory || []).find(t => t.id === tradeId);
      if (!trade) return;
      const asset = tradingAssets.find(a => a.id === trade.assetId);
      if (!asset) return;
      const typeClass = trade.type === 'buy' ? 'transaction-negative' : 'transaction-positive';
      const sign = trade.type === 'buy' ? '-' : '+';
      let plInfo = '';
      if (trade.type === 'sell') {
        const plClass = trade.profit >= 0 ? 'profit-positive' : 'profit-negative';
        plInfo = `<div class="info-row">
          <div class="info-label">Profit/Loss</div>
          <div class="info-value ${plClass}">$${trade.profit.toFixed(2)}</div>
        </div>`;
      }
      document.getElementById('tradeDetailContent').innerHTML = `
        <div class="transaction-header">
          <div>
            <div class="transaction-type">${trade.type.toUpperCase()} ${asset.name}</div>
            <div class="transaction-date">${new Date(trade.timestamp).toLocaleString()}</div>
          </div>
          <div class="transaction-amount ${typeClass}">
            ${sign}$${trade.totalUSD.toFixed(2)}
          </div>
        </div>
        <div class="transaction-info">
          <div class="info-row">
            <div class="info-label">Units</div>
            <div class="info-value">${trade.units.toLocaleString(undefined, {maximumFractionDigits: 4})} ${asset.unit}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Price per Unit</div>
            <div class="info-value">$${trade.price.toFixed(2)}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Total Value</div>
            <div class="info-value">${sign}$${trade.totalUSD.toFixed(2)}</div>
          </div>
          ${plInfo}
          <div class="info-row">
            <div class="info-label">Trade ID</div>
            <div class="info-value">${trade.id}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Status</div>
            <div class="info-value">Executed</div>
          </div>
        </div>
      `;
      document.getElementById('tradeDetailModal').style.display = 'flex';
    }
    
    // Auto-login function
    async function autoLoginIfPossible() {
      await loadAllUsers();
      
      // Check if user is already logged in
      const savedAccount = localStorage.getItem('fintrust_current_account');
      if (savedAccount) {
        const snapshot = await get(ref(db, `users/${savedAccount}`));
        if (snapshot.exists()) {
          currentUser = snapshot.val();
          if (currentUser.status === 'suspended') {
            localStorage.removeItem('fintrust_current_account');
            showNotification('User account suspended 🔒', 'error');
            showAuth();
            return;
          }
          // Initialize missing fields
          currentUser.balance = currentUser.balance || 0;
          currentUser.loanLimit = currentUser.loanLimit || (appConfig.initialLoanLimit || 10000);
          currentUser.investments = currentUser.investments || [];
          currentUser.tradingPortfolio = currentUser.tradingPortfolio || [];
          currentUser.tradeHistory = currentUser.tradeHistory || [];
          if (currentUser.tradeHistory) {
            currentUser.tradeHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          }
          currentUser.transactions = currentUser.transactions || [];
          currentUser.loans = currentUser.loans || [];
          currentUser.businesses = currentUser.businesses || [];
          currentUser.walletPin = currentUser.walletPin || null;
          currentUser.notifications = currentUser.notifications || {
            email: true,
            sms: false,
            alerts: true
          };
          currentUser.preferences = currentUser.preferences || {
            currency: 'USD',
            language: 'en'
          };
          currentAccount = savedAccount;
          initCharts();
          attachUserListener(savedAccount);
          await showApp();
        } else {
          localStorage.removeItem('fintrust_current_account');
        }
      } else {
        document.getElementById('authContainer').classList.remove('hidden');
      }
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
      // Setup authentication links
      document.getElementById('showRegisterLink').addEventListener('click', function(e) {
        e.preventDefault();
        showRegisterForm();
      });
      
      document.getElementById('showLoginLink').addEventListener('click', function(e) {
        e.preventDefault();
        showLoginForm();
      });
      
      // New: Attach config listener early
      attachConfigListener();
      
      // Wait for loaded flag from loader, then auto-login or show auth
      const checkLoaded = setInterval(() => {
        if (document.body.classList.contains('loaded')) {
          clearInterval(checkLoaded);
          autoLoginIfPossible();
        }
      }, 100);
      
      // Setup navigation
      document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', function() {
          const tab = this.getAttribute('data-tab');
          if (tab) {
            openTab(tab);
          }
        });
      });
      
      // Setup settings navigation
      document.querySelectorAll('.settings-item').forEach(item => {
        item.addEventListener('click', function() {
          const setting = this.getAttribute('data-setting');
          document.querySelectorAll('.settings-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.settings-content > div').forEach(div => div.classList.add('hidden'));
          document.getElementById(`${setting}Settings`).classList.remove('hidden');
        });
      });
      
      // Setup account number lookup
      document.getElementById('recipientAccount').addEventListener('input', async function() {
        const accountNumber = this.value;
        const recipientInfo = document.getElementById('recipientInfo');
        if (accountNumber.length === 8) {
          const recipient = await findUserByAccount(accountNumber);
          if (recipient && recipient.status !== 'suspended') { // New: Check not suspended
            document.getElementById('recipientName').textContent = recipient.name;
            document.getElementById('recipientAccountDisplay').textContent = accountNumber;
            recipientInfo.classList.remove('hidden');
          } else {
            recipientInfo.classList.add('hidden');
            showNotification('Account number not found or suspended', 'error');
          }
        } else {
          recipientInfo.classList.add('hidden');
        }
      });
      
      // Setup list-item click handlers for details
      document.addEventListener('click', async function(e) {
        const item = e.target.closest('.list-item');
        if (!item) return;
        const transactionId = item.dataset.transactionId;
        const investmentId = item.dataset.investmentId;
        const tradeId = item.dataset.tradeId;
        if (transactionId) {
          showTransactionDetail(parseInt(transactionId));
        } else if (investmentId) {
          showInvestmentDetail(parseInt(investmentId));
        } else if (tradeId) {
          showTradeDetail(parseInt(tradeId));
        }
      });
    });
    
    // Tab Navigation
    async function openTab(tabName) {
      // Update active tab in sidebar
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.add('active');
      
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      
      // Update charts when switching to relevant tabs
      if (tabName === 'dashboard') {
        await updateCharts();
      } else if (tabName === 'trading') {
        initTrading();
      } else if (tabName === 'investments') {
        await updateCharts();
        updateInvestmentSummary();
      } else if (tabName === 'wallet') {
        await updateCharts();
      } else if (tabName === 'loans') {
        await updateCharts();
        updateLoanLimitDisplay();
      } else if (tabName === 'business') {
        await updateCharts();
      } else if (tabName === 'help-center') {
        renderComplaints(); // Ensure complaints are rendered
      }
    }
    
    // Show Investment Detail
    function showInvestmentDetail(investmentId) {
      const investment = (currentUser.investments || []).find(inv => inv.id === investmentId);
      if (!investment) return;
      
      const currentValue = calculateCurrentValue(investment);
      const profit = calculateProfit(investment);
      
      document.getElementById('assetDetailContent').innerHTML = `
        <div class="asset-detail-header">
          <div class="asset-detail-icon">
            <i class="${investment.icon}"></i>
          </div>
          <div class="asset-detail-name">${investment.name}</div>
          <div class="asset-detail-type">${investment.type}</div>
        </div>
        <p>${investment.description}</p>
        
        <div class="asset-stats">
          <div class="stat-item">
            <div class="stat-label">Purchase Price</div>
            <div class="stat-value">$${investment.purchasePrice.toLocaleString()}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Current Value</div>
            <div class="stat-value">$${currentValue.toLocaleString()}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Profit</div>
            <div class="stat-value">+$${profit.toLocaleString()}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Version</div>
            <div class="stat-value">v${investment.version || 1}</div>
          </div>
        </div>
        
        <div class="form-group">
          <button class="btn btn-success" onclick="sellAsset(${investment.id})">
            <i class="fas fa-dollar-sign"></i> Sell Asset
          </button>
          <button class="btn btn-warning" onclick="upgradeAsset(${investment.id})">
            <i class="fas fa-arrow-up"></i> Upgrade ($500)
          </button>
        </div>
      `;
      
      document.getElementById('assetDetailModal').style.display = 'flex';
    }
    
    // Initialize Charts
    function initCharts() {
      // Financial Overview Chart
      const financialCtx = document.getElementById('financialChart').getContext('2d');
      if (financialChart) {
        financialChart.destroy();
        financialChart = null;
      }
      financialChart = new Chart(financialCtx, {
        type: 'bar',
        data: {
          labels: ['Balance', 'Investments', 'Loans', 'Business'],
          datasets: [{
            label: 'Financial Overview',
            data: [1000, 0, 0, 0],
            backgroundColor: [
              'rgba(13, 71, 161, 0.7)',
              'rgba(46, 125, 50, 0.7)',
              'rgba(198, 40, 40, 0.7)',
              'rgba(245, 127, 23, 0.7)'
            ],
            borderColor: [
              'rgba(13, 71, 161, 1)',
              'rgba(46, 125, 50, 1)',
              'rgba(198, 40, 40, 1)',
              'rgba(245, 127, 23, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Portfolio Chart
      const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
      if (portfolioChart) {
        portfolioChart.destroy();
        portfolioChart = null;
      }
      portfolioChart = new Chart(portfolioCtx, {
        type: 'doughnut',
        data: {
          labels: ['No Investments'],
          datasets: [{
            data: [100],
            backgroundColor: ['rgba(200, 200, 200, 0.7)'],
            borderColor: ['rgba(150, 150, 150, 1)'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Transaction Chart
      const transactionCtx = document.getElementById('transactionChart').getContext('2d');
      if (transactionChart) {
        transactionChart.destroy();
        transactionChart = null;
      }
      transactionChart = new Chart(transactionCtx, {
        type: 'line',
        data: {
          labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          datasets: [{
            label: 'Account Balance',
            data: [0, 0, 0, 1000],
            fill: true,
            backgroundColor: 'rgba(13, 71, 161, 0.2)',
            borderColor: 'rgba(13, 71, 161, 1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
      
      // Loan Chart
      const loanCtx = document.getElementById('loanChart').getContext('2d');
      if (loanChart) {
        loanChart.destroy();
        loanChart = null;
      }
      loanChart = new Chart(loanCtx, {
        type: 'bar',
        data: {
          labels: ['No Loans'],
          datasets: [{
            label: 'Repayment Schedule',
            data: [0],
            backgroundColor: 'rgba(200, 200, 200, 0.7)',
            borderColor: 'rgba(150, 150, 150, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Business Chart
      const businessCtx = document.getElementById('businessChart').getContext('2d');
      if (businessChart) {
        businessChart.destroy();
        businessChart = null;
      }
      businessChart = new Chart(businessCtx, {
        type: 'line',
        data: {
          labels: ['Month 1', 'Month 2', 'Month 3', 'Month 4', 'Month 5', 'Month 6'],
          datasets: [{
            label: 'Projected Profit',
            data: [0, 0, 0, 0, 0, 0],
            fill: true,
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            borderColor: 'rgba(46, 125, 50, 1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }
    
    // Update Charts (updated to include trading with safeguards)
    async function updateCharts() {
      if (!currentUser) return;
      
      let tradingValue = 0;
      (currentUser.tradingPortfolio || []).forEach(pos => {
        const asset = tradingAssets.find(a => a.id === pos.id);
        if (!asset) return;
        const price = marketPrices[pos.id] || asset.basePrice;
        const currentValue = asset.isFiat ? pos.units / price : pos.units * price;
        tradingValue += currentValue;
      });
      
      // Financial Chart
      if (financialChart) {
        financialChart.data.datasets[0].data = [
          currentUser.balance,
          (currentUser.investments || []).reduce((sum, inv) => sum + calculateCurrentValue(inv), 0) + tradingValue,
          (currentUser.loans || []).reduce((sum, loan) => sum + (loan.totalRepayment || 0), 0),
          (currentUser.businesses || []).reduce((sum, bus) => sum + (bus.cost || 0), 0)
        ];
        financialChart.update();
      }
      
      // Portfolio Chart
      if (portfolioChart) {
        if ((currentUser.investments || []).length > 0) {
          const investmentData = (currentUser.investments || []).map(inv => calculateCurrentValue(inv));
          const investmentLabels = (currentUser.investments || []).map(inv => inv.name);
          const backgroundColors = [
            'rgba(46, 125, 50, 0.7)',
            'rgba(25, 118, 210, 0.7)',
            'rgba(245, 127, 23, 0.7)',
            'rgba(198, 40, 40, 0.7)',
            'rgba(106, 27, 154, 0.7)',
            'rgba(0, 151, 167, 0.7)'
          ];
          const borderColors = [
            'rgba(46, 125, 50, 1)',
            'rgba(25, 118, 210, 1)',
            'rgba(245, 127, 23, 1)',
            'rgba(198, 40, 40, 1)',
            'rgba(106, 27, 154, 1)',
            'rgba(0, 151, 167, 1)'
          ];
          
          portfolioChart.data.labels = investmentLabels;
          portfolioChart.data.datasets[0].data = investmentData;
          portfolioChart.data.datasets[0].backgroundColor = backgroundColors.slice(0, investmentData.length);
          portfolioChart.data.datasets[0].borderColor = borderColors.slice(0, investmentData.length);
        } else {
          portfolioChart.data.labels = ['No Investments'];
          portfolioChart.data.datasets[0].data = [100];
          portfolioChart.data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
          portfolioChart.data.datasets[0].borderColor = ['rgba(150, 150, 150, 1)'];
        }
        portfolioChart.update();
      }
      
      // Transaction Chart
      if (transactionChart) {
        const transactionData = [0, 0, 0, 0];
        let balance = 0;
        const recentTransactions = (currentUser.transactions || []).slice(-4);
        recentTransactions.forEach((t, index) => {
          balance += t.amount;
          transactionData[index] = balance;
        });
        transactionChart.data.datasets[0].data = transactionData;
        transactionChart.update();
      }
      
      // Loan Chart
      if (loanChart) {
        if ((currentUser.loans || []).length > 0) {
          const loanLabels = (currentUser.loans || []).map((loan, i) => `Loan ${i+1}`);
          const loanData = (currentUser.loans || []).map(loan => loan.totalRepayment || 0);
          loanChart.data.labels = loanLabels;
          loanChart.data.datasets[0].data = loanData;
          loanChart.data.datasets[0].backgroundColor = 'rgba(198, 40, 40, 0.7)';
          loanChart.data.datasets[0].borderColor = 'rgba(198, 40, 40, 1)';
        } else {
          loanChart.data.labels = ['No Loans'];
          loanChart.data.datasets[0].data = [0];
          loanChart.data.datasets[0].backgroundColor = 'rgba(200, 200, 200, 0.7)';
          loanChart.data.datasets[0].borderColor = 'rgba(150, 150, 150, 1)';
        }
        loanChart.update();
      }
      
      // Business Chart
      if (businessChart) {
        if ((currentUser.businesses || []).length > 0) {
          const monthlyProfit = (currentUser.businesses || []).reduce((sum, bus) => sum + ((bus.monthlyProfit || 0) * (appConfig.businessProfitMultiplier || 1)), 0);
          const businessData = [0, monthlyProfit, monthlyProfit*2, monthlyProfit*3, monthlyProfit*4, monthlyProfit*5];
          businessChart.data.datasets[0].data = businessData;
        } else {
          businessChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
        }
        businessChart.update();
      }
      
      // Update stats
      const totalAssets = currentUser.balance + 
                          (currentUser.investments || []).reduce((sum, inv) => sum + calculateCurrentValue(inv), 0) + tradingValue + 
                          (currentUser.businesses || []).reduce((sum, bus) => sum + (bus.cost || 0), 0);
      const totalDebt = (currentUser.loans || []).reduce((sum, loan) => sum + (loan.totalRepayment || 0), 0);
      const netWorth = totalAssets - totalDebt;
      const monthlyIncome = (currentUser.businesses || []).reduce((sum, bus) => sum + ((bus.monthlyProfit || 0) * (appConfig.businessProfitMultiplier || 1)), 0);
      const debtRatio = totalAssets > 0 ? Math.round((totalDebt / totalAssets) * 100) : 0;
      
      document.getElementById('total-assets').textContent = `$${totalAssets.toLocaleString()}`;
      document.getElementById('net-worth').textContent = `$${netWorth.toLocaleString()}`;
      document.getElementById('monthly-income').textContent = `$${monthlyIncome.toLocaleString()}`;
      document.getElementById('debt-ratio').textContent = `${debtRatio}%`;
    }
    
    // Updated: Calculate current value of investment based on time (with multiplier)
    function calculateCurrentValue(investment) {
      const now = new Date();
      const purchaseDate = new Date(investment.purchaseDate);
      const minutesElapsed = (now - purchaseDate) / (1000 * 60);
      
      // Cap at max time
      const cappedMinutes = Math.min(minutesElapsed, investment.maxTime);
      
      // Calculate profit with multiplier
      const effectiveRate = investment.profitRate * (appConfig.investmentProfitMultiplier || 1);
      const profit = investment.purchasePrice * effectiveRate * cappedMinutes;
      return investment.purchasePrice + profit;
    }
    
    // Calculate profit for investment
    function calculateProfit(investment) {
      return calculateCurrentValue(investment) - investment.purchasePrice;
    }
    
    // Render Assets
    function renderAssets() {
      const assetGrid = document.getElementById('assetGrid');
      assetGrid.innerHTML = '';
      assets.forEach(asset => {
        const card = document.createElement('div');
        card.classList.add('asset-card');
        card.innerHTML = `
          <div class="asset-image">
            <i class="${asset.icon}"></i>
          </div>
          <div class="asset-details">
            <div class="asset-name">${asset.name}</div>
            <div class="asset-type">${asset.type}</div>
            <div class="asset-price">$${asset.price.toLocaleString()}</div>
            <div class="asset-actions">
              <button class="btn btn-primary" onclick="buyAsset(${asset.id})">
                <i class="fas fa-shopping-cart"></i> Buy
              </button>
              <button class="btn btn-outline" onclick="showAssetDetail(${asset.id})">
                <i class="fas fa-info-circle"></i> Details
              </button>
            </div>
          </div>
        `;
        assetGrid.appendChild(card);
      });
    }
    
    // Show Asset Detail
    window.showAssetDetail = function(assetId) {
      const asset = assets.find(a => a.id === assetId);
      if (!asset) return;
      
      document.getElementById('assetDetailContent').innerHTML = `
        <div class="asset-detail-header">
          <div class="asset-detail-icon">
            <i class="${asset.icon}"></i>
          </div>
          <div class="asset-detail-name">${asset.name}</div>
          <div class="asset-detail-type">${asset.type}</div>
        </div>
        <p>${asset.description}</p>
        
        <div class="asset-stats">
          <div class="stat-item">
            <div class="stat-label">Purchase Price</div>
            <div class="stat-value">$${asset.price.toLocaleString()}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Profit Rate</div>
            <div class="stat-value">${((asset.profitRate * (appConfig.investmentProfitMultiplier || 1)) * 100).toFixed(1)}% per minute</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Min. Time</div>
            <div class="stat-value">${asset.minTime} minutes</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Max. Time</div>
            <div class="stat-value">${asset.maxTime} minutes</div>
          </div>
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" onclick="buyAsset(${asset.id})">
            <i class="fas fa-shopping-cart"></i> Purchase Asset
          </button>
        </div>
      `;
      
      document.getElementById('assetDetailModal').style.display = 'flex';
    }
    
    // Render Business Options
    function renderBusinessOptions() {
      const businessGrid = document.getElementById('businessOptions');
      businessGrid.innerHTML = '';
      businesses.forEach(business => {
        const effectiveProfit = business.monthlyProfit * (appConfig.businessProfitMultiplier || 1);
        const card = document.createElement('div');
        card.classList.add('asset-card');
        card.innerHTML = `
          <div class="asset-image">
            <i class="${business.icon}"></i>
          </div>
          <div class="asset-details">
            <div class="asset-name">${business.name}</div>
            <div class="asset-type">Business Venture</div>
            <div class="asset-price">Cost: $${business.cost.toLocaleString()}</div>
            <div class="asset-type">Monthly Profit: $${effectiveProfit.toLocaleString()}</div>
            <div class="asset-actions">
              <button class="btn btn-primary" onclick="startBusiness('${business.name}', ${business.cost}, ${effectiveProfit})">
                <i class="fas fa-briefcase"></i> Start Business
              </button>
            </div>
          </div>
        `;
        businessGrid.appendChild(card);
      });
    }
    
    // Buy Asset
    window.buyAsset = async function(id) {
      if (!currentUser) return;
      
      const asset = assets.find(a => a.id === id);
      if (asset && currentUser.balance >= asset.price) {
        currentUser.balance -= asset.price;
        if (!currentUser.investments) currentUser.investments = [];
        currentUser.investments.push({ 
          ...asset, 
          purchasePrice: asset.price,
          purchaseDate: new Date().toISOString(),
          version: 1
        });
        addTransaction(`Bought ${asset.name}`, -asset.price, 'investment');
        await updateDashboard();
        await updateWallet();
        renderInvestments();
        await updateCharts();
        await saveUserData();
        logActivity('buy_asset', `${asset.name} for $${asset.price}`);
        showNotification(`Successfully bought ${asset.name}!`, 'success');
        closeModal('assetDetailModal');
      } else {
        showNotification("Not enough funds!", 'error');
      }
    }
    
    // Sell Asset
    window.sellAsset = async function(id) {
      if (!currentUser) return;
      
      const investment = (currentUser.investments || []).find(inv => inv.id === id);
      if (investment) {
        const currentPrice = calculateCurrentValue(investment);
        currentUser.balance += currentPrice;
        currentUser.investments = (currentUser.investments || []).filter(inv => inv.id !== id);
        const profit = currentPrice - investment.purchasePrice;
        addTransaction(`Sold ${investment.name} (Profit: $${profit.toLocaleString()})`, currentPrice, 'investment');
        await updateDashboard();
        await updateWallet();
        renderInvestments();
        await updateCharts();
        await saveUserData();
        logActivity('sell_asset', `${investment.name} for $${currentPrice.toLocaleString()}`);
        showNotification(`Sold ${investment.name} for a profit of $${profit.toLocaleString()}!`, 'success');
      }
    }
    
    // Upgrade Asset
    window.upgradeAsset = async function(id) {
      if (!currentUser) return;
      
      const investment = (currentUser.investments || []).find(inv => inv.id === id);
      if (investment) {
        const upgradeCost = 500;
        if (currentUser.balance >= upgradeCost) {
          currentUser.balance -= upgradeCost;
          investment.version = (investment.version || 1) + 1;
          investment.purchasePrice += upgradeCost;
          investment.purchaseDate = new Date().toISOString(); // Reset timer
          
          addTransaction(`Upgraded ${investment.name} to v${investment.version}`, -upgradeCost, 'upgrade');
          await updateDashboard();
          await updateWallet();
          renderInvestments();
          await updateCharts();
          await saveUserData();
          logActivity('upgrade_asset', `${investment.name} to v${investment.version}`);
          showNotification(`Upgraded ${investment.name} to version ${investment.version}!`, 'success');
        } else {
          showNotification("Not enough funds for upgrade!", 'error');
        }
      }
    }
    
    // Render Investments
    async function renderInvestments() {
      if (!currentUser) return;
      
      const investmentList = document.getElementById('investmentList');
      if ((currentUser.investments || []).length === 0) {
        investmentList.innerHTML = '<p class="text-center">You haven\'t made any investments yet.</p>';
        return;
      }
      
      investmentList.innerHTML = '';
      (currentUser.investments || []).forEach(investment => {
        const currentPrice = calculateCurrentValue(investment);
        const profit = calculateProfit(investment);
        const profitPercentage = ((profit / investment.purchasePrice) * 100).toFixed(1);
        const now = new Date();
        const purchaseDate = new Date(investment.purchaseDate);
        const minutesElapsed = Math.floor((now - purchaseDate) / (1000 * 60));
        const cappedMinutes = Math.min(minutesElapsed, investment.maxTime);
        
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.dataset.investmentId = investment.id;
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">
              ${investment.name} 
              <span class="current-version">v${investment.version || 1}</span>
            </div>
            <div class="list-item-detail">Purchased at $${investment.purchasePrice.toLocaleString()}</div>
            <div class="list-item-detail">Current Value: $${currentPrice.toLocaleString()} 
              <span class="profit-indicator ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                ${profit >= 0 ? '+' : ''}${profitPercentage}%
              </span>
            </div>
            <div class="list-item-detail">Time Elapsed: ${cappedMinutes} min / ${investment.maxTime} min</div>
          </div>
          <div class="list-actions">
            <button class="btn btn-success" onclick="sellAsset(${investment.id})">
              <i class="fas fa-dollar-sign"></i> Sell
            </button>
            <button class="btn btn-warning" onclick="upgradeAsset(${investment.id})">
              <i class="fas fa-arrow-up"></i> Upgrade ($500)
            </button>
          </div>
        `;
        investmentList.appendChild(li);
      });
      
      updateInvestmentSummary();
    }
    
    // Update Investment Summary
    function updateInvestmentSummary() {
      if (!currentUser) return;
      
      const totalInvested = (currentUser.investments || []).reduce((sum, inv) => sum + (inv.purchasePrice || 0), 0);
      const currentValue = (currentUser.investments || []).reduce((sum, inv) => sum + calculateCurrentValue(inv), 0);
      const totalProfit = currentValue - totalInvested;
      const roi = totalInvested > 0 ? ((totalProfit / totalInvested) * 100).toFixed(1) : 0;
      
      document.getElementById('total-invested').textContent = `$${totalInvested.toLocaleString()}`;
      document.getElementById('current-value').textContent = `$${currentValue.toLocaleString()}`;
      document.getElementById('total-profit').textContent = `$${totalProfit.toLocaleString()}`;
      document.getElementById('roi').textContent = `${roi}%`;
    }
    
    // Wallet Functions
    async function updateWallet() {
      if (!currentUser) return;
      document.getElementById('walletBalance').textContent = `$${currentUser.balance.toLocaleString()}`;
    }
    
    window.openTransferModal = function() {
      document.getElementById('transferModal').style.display = 'flex';
      document.getElementById('recipientAccount').value = '';
      document.getElementById('recipientInfo').classList.add('hidden');
      transferAmount = '0';
      document.getElementById('transferAmountDisplay').textContent = '$0.00';
      document.getElementById('transferDescription').value = '';
    }
    
    window.openPinModal = function() {
      currentPin = '';
      document.getElementById('pinDisplay').textContent = '----';
      document.getElementById('pinModal').style.display = 'flex';
    }
    
    window.closeModal = function(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    window.addPinDigit = function(digit) {
      if (currentPin.length < 4) {
        currentPin += digit;
        document.getElementById('pinDisplay').textContent = currentPin.padEnd(4, '•');
      }
    }
    
    window.clearPin = function() {
      currentPin = currentPin.slice(0, -1);
      document.getElementById('pinDisplay').textContent = currentPin.padEnd(4, '•') || '----';
    }
    
    window.confirmPin = async function() {
      if (currentPin.length === 4) {
        currentUser.walletPin = currentPin;
        await saveUserData();
        closeModal('pinModal');
        logActivity('set_pin', 'Wallet PIN set/changed');
        showNotification('Wallet PIN set successfully!', 'success');
        // If transfer in progress, reopen password modal
        if (window.transferDetails) {
          document.getElementById('confirmRecipientName').textContent = window.transferDetails.recipient.name;
          document.getElementById('confirmRecipientAccount').textContent = window.transferDetails.recipient.accountNumber;
          document.getElementById('confirmTransferAmount').textContent = window.transferDetails.amount.toLocaleString();
          transferPin = '';
          document.getElementById('transferPinDisplay').textContent = '----';
          document.getElementById('passwordModal').style.display = 'flex';
        }
      } else {
        showNotification('Please enter a 4-digit PIN', 'error');
      }
    }
    
    // Transfer Amount Keypad Functions
    window.addTransferAmount = function(digit) {
      if (digit === '.' && transferAmount.includes('.')) return;
      if (digit === '.' && transferAmount === '0') {
        transferAmount = '0.';
        document.getElementById('transferAmountDisplay').textContent = '$0.';
        return;
      }
      transferAmount += digit;
      document.getElementById('transferAmountDisplay').textContent = `$${parseFloat(transferAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    window.clearTransferAmount = function() {
      transferAmount = transferAmount.slice(0, -1);
      if (transferAmount === '' || transferAmount === '0.') transferAmount = '0';
      document.getElementById('transferAmountDisplay').textContent = `$${parseFloat(transferAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Transfer PIN Keypad Functions
    window.addTransferPin = function(digit) {
      if (transferPin.length < 4) {
        transferPin += digit;
        document.getElementById('transferPinDisplay').textContent = transferPin.padEnd(4, '•');
      }
    }
    
    window.clearTransferPin = function() {
      transferPin = transferPin.slice(0, -1);
      document.getElementById('transferPinDisplay').textContent = transferPin.padEnd(4, '•') || '----';
    }
    
    window.confirmTransferPin = function() {
      if (transferPin.length === 4) {
        confirmTransferWithPin(transferPin);
      } else {
        showNotification('Please enter a 4-digit PIN', 'error');
      }
    }
    
    // Transfer Functions
    window.validateTransfer = async function() {
      const accountNumber = document.getElementById('recipientAccount').value;
      const amount = parseFloat(transferAmount);
      
      if (accountNumber.length !== 8) {
        showNotification('Please enter a valid 8-digit account number', 'error');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        showNotification('Please enter a valid amount', 'error');
        return;
      }
      
      if (currentUser.balance < amount) {
        showNotification('Insufficient funds for this transfer', 'error');
        return;
      }
      
      const recipient = await findUserByAccount(accountNumber);
      if (!recipient || recipient.status === 'suspended') {
        showNotification('Recipient account not found or suspended', 'error');
        return;
      }
      
      if (recipient.id === currentUser.id) {
        showNotification('Cannot transfer to your own account', 'error');
        return;
      }
      
      // Store transfer details
      window.transferDetails = {
        recipient: recipient,
        amount: amount,
        description: document.getElementById('transferDescription').value || 'Money transfer'
      };
      
      // Show password modal with keypad
      document.getElementById('confirmRecipientName').textContent = recipient.name;
      document.getElementById('confirmRecipientAccount').textContent = accountNumber;
      document.getElementById('confirmTransferAmount').textContent = amount.toLocaleString();
      transferPin = '';
      document.getElementById('transferPinDisplay').textContent = '----';
      document.getElementById('passwordModal').style.display = 'flex';
      closeModal('transferModal');
    }
    
    async function confirmTransferWithPin(pin) {
      if (!window.transferDetails) {
        showNotification('Transfer details not found', 'error');
        return;
      }
      
      if (!currentUser.walletPin) {
        showNotification('Please set a wallet PIN in Settings first', 'error');
        closeModal('passwordModal');
        openPinModal();
        return;
      }
      
      if (pin !== currentUser.walletPin) {
        showNotification('Invalid PIN', 'error');
        transferPin = '';
        document.getElementById('transferPinDisplay').textContent = '----';
        return;
      }
      
      // Perform transfer
      const { recipient, amount, description } = window.transferDetails;
      
      // Deduct from sender
      currentUser.balance -= amount;
      const transactionId = Date.now();
      addTransaction({
        id: transactionId,
        description: `Transfer to ${recipient.name} (${recipient.accountNumber})`,
        amount: -amount,
        date: new Date().toISOString(),
        type: 'transfer',
        details: description
      });
      await saveUserData();
      logActivity('transfer', `To ${recipient.accountNumber} for $${amount.toLocaleString()}`);
      
      // Add to recipient
      const recipientAcc = recipient.accountNumber;
      const recipientRef = ref(db, `users/${recipientAcc}`);
      const snap = await get(recipientRef);
      if (snap.exists()) {
        const recipData = snap.val();
        recipData.balance += amount;
        const newTrans = {
          id: Date.now(),
          description: `Transfer from ${currentUser.name} (${currentUser.accountNumber})`,
          amount: amount,
          date: new Date().toISOString(),
          type: 'transfer',
          details: description
        };
        recipData.transactions = [newTrans, ...(recipData.transactions || [])];
        await set(recipientRef, recipData);
      }
      
      // Update UI
      await updateDashboard();
      await updateWallet();
      await renderTransactions();
      await updateCharts();
      
      // Generate receipt
      generateReceipt(recipient, amount, description, transactionId);
      
      // Close modals
      closeModal('passwordModal');
      window.transferDetails = null;
      
      showNotification(`Transfer of $${amount.toLocaleString()} to ${recipient.name} completed successfully!`, 'success');
    }
    
    function generateReceipt(recipient, amount, description, transactionId) {
      const receiptId = 'FT-' + Math.floor(100000000 + Math.random() * 900000000);
      const now = new Date();
      const dateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      
      document.getElementById('receiptId').textContent = receiptId;
      document.getElementById('receiptDateTime').textContent = dateTime;
      document.getElementById('receiptFromAccount').textContent = currentUser.accountNumber;
      document.getElementById('receiptToAccount').textContent = recipient.accountNumber;
      document.getElementById('receiptRecipientName').textContent = recipient.name;
      document.getElementById('receiptDescription').textContent = description;
      document.getElementById('receiptAmount').textContent = `$${amount.toLocaleString()}`;
      
      document.getElementById('receiptModal').style.display = 'flex';
    }
    
    window.downloadReceipt = function() {
      const receipt = document.getElementById('receiptContent');
      
      html2canvas(receipt).then(canvas => {
        const link = document.createElement('a');
        link.download = 'fintrust-receipt.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
    
    // Transactions
    function filterTransactions() {
      transactionSearchTerm = document.getElementById('transactionSearch').value.toLowerCase();
      renderTransactions();
    }
    
    window.setTransactionFilter = function(filter, btn) {
      currentTransactionFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderTransactions();
    }
    
    async function renderTransactions() {
      if (!currentUser) return;
      
      const transactionHistory = document.getElementById('transactionHistory');
      let transactions = (currentUser.transactions || []).slice(0, 50); // Limit to recent 50 for performance
      
      // Apply filter
      if (currentTransactionFilter !== 'all') {
        transactions = transactions.filter(t => t.type === currentTransactionFilter);
      }
      
      // Apply search
      if (transactionSearchTerm) {
        transactions = transactions.filter(t => t.description.toLowerCase().includes(transactionSearchTerm));
      }
      
      if (transactions.length === 0) {
        transactionHistory.innerHTML = '<p class="text-center">No transactions match the criteria</p>';
        // Update recent transactions
        const recentTransactions = document.getElementById('recent-transactions');
        recentTransactions.innerHTML = '<p class="text-center">No recent transactions</p>';
        return;
      }
      
      // Render full transaction history
      transactionHistory.innerHTML = '';
      transactions.forEach(transaction => {
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.dataset.transactionId = transaction.id;
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">${transaction.description}</div>
            <div class="list-item-detail">${new Date(transaction.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align: right;">
            <div class="list-item-title" style="color: ${transaction.amount >= 0 ? '#2e7d32' : '#c62828'}">
              ${transaction.amount >= 0 ? '+' : '-'}$${Math.abs(transaction.amount).toLocaleString()}
            </div>
          </div>
        `;
        transactionHistory.appendChild(li);
      });
      
      // Update recent transactions (top 3 unfiltered)
      const recentTransactionsEl = document.getElementById('recent-transactions');
      recentTransactionsEl.innerHTML = '';
      const allRecent = (currentUser.transactions || []).slice(0, 3);
      allRecent.forEach(transaction => {
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.dataset.transactionId = transaction.id;
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">${transaction.description}</div>
            <div class="list-item-detail">${new Date(transaction.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align: right;">
            <div class="list-item-title" style="color: ${transaction.amount >= 0 ? '#2e7d32' : '#c62828'}">
              ${transaction.amount >= 0 ? '+' : '-'}$${Math.abs(transaction.amount).toLocaleString()}
            </div>
          </div>
        `;
        recentTransactionsEl.appendChild(li);
      });
      
      if ((currentUser.transactions || []).length > 50) {
        const viewAll = document.createElement('div');
        viewAll.classList.add('text-center', 'mt-2');
        viewAll.innerHTML = '<button class="btn btn-outline">View Older Transactions</button>';
        transactionHistory.appendChild(viewAll);
      }
    }
    
    window.exportTransactions = function() {
      let transactions = (currentUser.transactions || []).slice(0, 100); // Export recent 100
      const csv = [
        ['ID', 'Description', 'Amount', 'Date', 'Type', 'Details'],
        ...transactions.map(t => [
          t.id,
          t.description,
          t.amount,
          new Date(t.date).toLocaleString(),
          t.type,
          t.details || ''
        ])
      ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fintrust-transactions-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      logActivity('export_transactions', 'Exported transaction history');
      showNotification('Transactions exported successfully!', 'success');
    }
    
    // Show Transaction Detail
    function showTransactionDetail(transactionId) {
      const transaction = (currentUser.transactions || []).find(t => t.id === parseInt(transactionId));
      if (!transaction) return;
      
      const transactionType = {
        'bonus': 'Welcome Bonus',
        'transfer': 'Transfer',
        'investment': 'Investment',
        'upgrade': 'Upgrade',
        'loan': 'Loan',
        'repayment': 'Repayment',
        'business': 'Business',
        'trade': 'Trade',
        'conversion': 'Conversion'
      }[transaction.type] || 'Transaction';
      
      const amountClass = transaction.amount >= 0 ? 'transaction-positive' : 'transaction-negative';
      const amountSign = transaction.amount >= 0 ? '+' : '-';
      
      document.getElementById('transactionDetailContent').innerHTML = `
        <div class="transaction-header">
          <div>
            <div class="transaction-type">${transactionType}</div>
            <div class="transaction-date">${new Date(transaction.date).toLocaleString()}</div>
          </div>
          <div class="transaction-amount ${amountClass}">
            ${amountSign}$${Math.abs(transaction.amount).toLocaleString()}
          </div>
        </div>
        
        <div class="transaction-info">
          <div class="info-row">
            <div class="info-label">Description</div>
            <div class="info-value">${transaction.description}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Transaction ID</div>
            <div class="info-value">${transaction.id}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Account</div>
            <div class="info-value">${currentUser.accountNumber}</div>
          </div>
          ${transaction.details ? `
          <div class="info-row">
            <div class="info-label">Details</div>
            <div class="info-value">${transaction.details}</div>
          </div>
          ` : ''}
          <div class="info-row">
            <div class="info-label">Status</div>
            <div class="info-value">Completed</div>
          </div>
        </div>
      `;
      
      document.getElementById('transactionDetailModal').style.display = 'flex';
    }
    
    // Loan System
    function updateLoanLimitDisplay() {
      if (!currentUser) return;
      document.getElementById('loanLimitDisplay').textContent = `Max Loan: $${currentUser.loanLimit.toLocaleString()}`;
      document.getElementById('loanAmount').max = currentUser.loanLimit;
    }

    window.takeLoan = async function() {
      if (!currentUser) return;
      
      if ((currentUser.loans || []).length > 0) {
        showNotification('You can only have one active loan at a time. Please repay your current loan first.', 'error');
        return;
      }
      
      const amount = parseFloat(document.getElementById('loanAmount').value);
      const term = parseInt(document.getElementById('loanTerm').value);
      
      if (isNaN(amount) || amount < 100 || amount > currentUser.loanLimit) {
        showNotification(`Loan amount must be between $100 and $${currentUser.loanLimit.toLocaleString()}`, 'error');
        return;
      }
      
      // Updated: Use config interest
      const interestRate = appConfig.loanInterest || 0.30; // Fixed 30% interest
      
      const totalRepayment = amount * (1 + interestRate);
      currentUser.balance += amount;
      if (!currentUser.loans) currentUser.loans = [];
      currentUser.loans.push({
        amount,
        term,
        interestRate,
        totalRepayment,
        takenDate: new Date().toISOString(),
        dueDate: new Date(Date.now() + term * 30 * 24 * 60 * 60 * 1000).toISOString()
      });
      
      addTransaction(`Loan Taken (${term} months)`, amount, 'loan');
      await updateDashboard();
      await updateWallet();
      renderLoans();
      await updateCharts();
      await saveUserData();
      logActivity('take_loan', `Amount: $${amount}, Term: ${term} months`);
      showNotification(`Loan of $${amount.toLocaleString()} approved! Repay $${totalRepayment.toLocaleString()} in ${term} months.`, 'success');
    }
    
    window.repayLoan = async function(index) {
      if (!currentUser) return;
      
      const loan = (currentUser.loans || [])[index];
      if (!loan) return;
      if (currentUser.balance >= loan.totalRepayment) {
        currentUser.balance -= loan.totalRepayment;
        const oldLimit = currentUser.loanLimit;
        const repaidAmount = loan.totalRepayment;
        const increase = 1.5 * repaidAmount;
        currentUser.loanLimit += increase;
        const newLimit = currentUser.loanLimit;
        currentUser.loans.splice(index, 1);
        
        addTransaction(`Loan Repaid (Limit increased by $${increase.toLocaleString()} to $${newLimit.toLocaleString()})`, -loan.totalRepayment, 'repayment');
        await updateDashboard();
        await updateWallet();
        renderLoans();
        await updateCharts();
        updateLoanLimitDisplay();
        await saveUserData();
        logActivity('repay_loan', `Repaid $${loan.totalRepayment.toLocaleString()}, Limit +$${increase.toLocaleString()}`);
        showNotification(`Loan repaid successfully! Your loan limit has been increased by $${increase.toLocaleString()} to $${newLimit.toLocaleString()}.`, 'success');
      } else {
        showNotification("Not enough funds to repay the loan!", 'error');
      }
    }
    
    async function renderLoans() {
      if (!currentUser) return;
      
      const loanList = document.getElementById('loanList');
      if ((currentUser.loans || []).length === 0) {
        loanList.innerHTML = '<p class="text-center">You don\'t have any active loans.</p>';
        return;
      }
      
      loanList.innerHTML = '';
      (currentUser.loans || []).forEach((loan, index) => {
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">Loan: $${loan.amount.toLocaleString()}</div>
            <div class="list-item-detail">Term: ${loan.term} months</div>
            <div class="list-item-detail">Interest: ${(loan.interestRate * 100).toFixed(1)}%</div>
            <div class="list-item-detail">Total Repayment: $${loan.totalRepayment.toLocaleString()}</div>
            <div class="list-item-detail">Due: ${new Date(loan.dueDate).toLocaleDateString()}</div>
            <div class="list-item-detail">
              <span class="loan-status loan-active">Active</span>
            </div>
          </div>
          <div class="list-actions">
            <button class="btn btn-danger" onclick="repayLoan(${index})">
              <i class="fas fa-hand-holding-usd"></i> Repay Now
            </button>
          </div>
        `;
        loanList.appendChild(li);
      });
    }
    
    // Business System
    window.startBusiness = async function(name, cost, monthlyProfit) {
      if (!currentUser) return;
      
      if (currentUser.balance >= cost) {
        currentUser.balance -= cost;
        if (!currentUser.businesses) currentUser.businesses = [];
        currentUser.businesses.push({
          name,
          cost,
          monthlyProfit,
          startedDate: new Date().toISOString()
        });
        addTransaction(`Started ${name} Business`, -cost, 'business');
        await updateDashboard();
        await updateWallet();
        renderBusinesses();
        await updateCharts();
        await saveUserData();
        logActivity('start_business', `${name} for $${cost}`);
        showNotification(`Successfully started ${name} business!`, 'success');
      } else {
        showNotification("Not enough funds to start this business!", 'error');
      }
    }
    
    window.collectBusinessProfit = async function(index) {
      if (!currentUser) return;
      
      const business = (currentUser.businesses || [])[index];
      if (!business) return;
      const effectiveProfit = business.monthlyProfit * (appConfig.businessProfitMultiplier || 1);
      currentUser.balance += effectiveProfit;
      addTransaction(`${business.name} Profit`, effectiveProfit, 'business');
      await updateDashboard();
      await updateWallet();
      await updateCharts();
      await saveUserData();
      logActivity('collect_profit', `${business.name} $${effectiveProfit.toLocaleString()}`);
      showNotification(`Collected $${effectiveProfit.toLocaleString()} from ${business.name}!`, 'success');
    }
    
    async function renderBusinesses() {
      if (!currentUser) return;
      
      const businessList = document.getElementById('businessList');
      if ((currentUser.businesses || []).length === 0) {
        businessList.innerHTML = '<p class="text-center">You haven\'t started any businesses yet.</p>';
        return;
      }
      
      businessList.innerHTML = '';
      (currentUser.businesses || []).forEach((business, index) => {
        const effectiveProfit = business.monthlyProfit * (appConfig.businessProfitMultiplier || 1);
        const li = document.createElement('div');
        li.classList.add('list-item');
        li.innerHTML = `
          <div class="list-item-content">
            <div class="list-item-title">${business.name}</div>
            <div class="list-item-detail">Initial Cost: $${business.cost.toLocaleString()}</div>
            <div class="list-item-detail">Monthly Profit: $${effectiveProfit.toLocaleString()}</div>
            <div class="list-item-detail">Started: ${new Date(business.startedDate).toLocaleDateString()}</div>
            <div class="list-item-detail">
              <span class="business-status">Active</span>
            </div>
          </div>
          <div class="list-actions">
            <button class="btn btn-success" onclick="collectBusinessProfit(${index})">
              <i class="fas fa-hand-holding-usd"></i> Collect Profit
            </button>
          </div>
        `;
        businessList.appendChild(li);
      });
    }
    
    // Dashboard Updates
    async function updateDashboard() {
      if (!currentUser) return;
      
      // Update balance
      document.getElementById('dashboard-balance').textContent = `$${currentUser.balance.toLocaleString()}`;
      
      // Update investments (include trading)
      let tradingValue = 0;
      (currentUser.tradingPortfolio || []).forEach(pos => {
        const asset = tradingAssets.find(a => a.id === pos.id);
        if (!asset) return;
        const price = marketPrices[pos.id] || asset.basePrice;
        const currentValue = asset.isFiat ? pos.units / price : pos.units * price;
        tradingValue += currentValue;
      });
      const totalInvestments = (currentUser.investments || []).reduce((sum, inv) => sum + calculateCurrentValue(inv), 0) + tradingValue;
      document.getElementById('dashboard-investments').textContent = `$${totalInvestments.toLocaleString()}`;
      
      // Update loans
      const totalLoans = (currentUser.loans || []).reduce((sum, loan) => sum + (loan.totalRepayment || 0), 0);
      document.getElementById('dashboard-loans').textContent = `$${totalLoans.toLocaleString()}`;
      
      // Update businesses
      const totalBusiness = (currentUser.businesses || []).reduce((sum, bus) => sum + (bus.cost || 0), 0);
      document.getElementById('dashboard-business').textContent = `$${totalBusiness.toLocaleString()}`;
    }
    
    // Notification System
    function showNotification(message, type = "success") {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        closeModal('transferModal');
        closeModal('passwordModal');
        closeModal('receiptModal');
        closeModal('transactionDetailModal');
        closeModal('tradeDetailModal');
        closeModal('assetDetailModal');
        closeModal('pinModal');
        closeModal('editComplaintModal');
        closeModal('tradeReceiptModal');
      }
    }
  </script>
</body>
</html>
